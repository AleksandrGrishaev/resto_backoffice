<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Debug</title>
<style>
  body { font-family: monospace; padding: 16px; background: #1a1a1a; color: #e0e0e0; font-size: 14px; }
  h2 { color: #4fc3f7; margin-top: 24px; }
  .item { padding: 4px 0; border-bottom: 1px solid #333; }
  .size { color: #ffd54f; font-weight: bold; }
  .total { color: #ef5350; font-size: 18px; font-weight: bold; margin: 16px 0; }
  button { background: #4fc3f7; color: #1a1a1a; border: none; padding: 14px 24px; font-size: 16px; border-radius: 8px; margin: 8px 4px; font-weight: bold; }
  button.red { background: #ef5350; color: white; }
  .ok { color: #66bb6a; }
  .fail { color: #ef5350; }
  .slow { color: #ffd54f; }
  #net-results div { padding: 6px 0; border-bottom: 1px solid #333; font-size: 15px; }
</style>
</head>
<body>

<h1>Network Test</h1>
<button onclick="runNetworkTests()">Run Network Tests</button>
<div id="net-results"></div>

<h1>localStorage</h1>
<div id="output"></div>
<button onclick="analyze()">Refresh</button>
<button class="red" onclick="if(confirm('Clear ALL?')) { localStorage.clear(); analyze(); }">NUKE ALL</button>

<script>
var SUPABASE_URL = 'https://fjkfckjpnbcyuknsnchy.supabase.co';

async function testFetch(label, url, timeout) {
  var el = document.getElementById('net-results');
  var start = Date.now();
  try {
    var ctrl = new AbortController();
    var timer = setTimeout(function() { ctrl.abort(); }, timeout);
    var resp = await fetch(url, { signal: ctrl.signal, cache: 'no-store' });
    clearTimeout(timer);
    var ms = Date.now() - start;
    var cls = ms > 3000 ? 'slow' : 'ok';
    el.innerHTML += '<div><span class="' + cls + '">' + (resp.ok ? 'OK' : 'HTTP ' + resp.status) + '</span> ' + label + ' — <strong>' + ms + 'ms</strong></div>';
    return { ok: resp.ok, ms: ms };
  } catch (e) {
    var ms2 = Date.now() - start;
    el.innerHTML += '<div><span class="fail">FAIL</span> ' + label + ' — ' + ms2 + 'ms — ' + e.message + '</div>';
    return { ok: false, ms: ms2, error: e.message };
  }
}

async function runNetworkTests() {
  var el = document.getElementById('net-results');
  el.innerHTML = '<div>Testing...</div>';

  // Basic internet
  el.innerHTML = '';
  await testFetch('Google (internet check)', 'https://www.google.com/generate_204', 10000);
  await testFetch('Cloudflare DNS', 'https://1.1.1.1/cdn-cgi/trace', 10000);

  // Supabase
  await testFetch('Supabase REST (health)', SUPABASE_URL + '/rest/v1/', 15000);
  await testFetch('Supabase Auth', SUPABASE_URL + '/auth/v1/settings', 15000);

  // RPC test (anonymous, will get auth error but proves connectivity)
  await testFetch('Supabase RPC ping', SUPABASE_URL + '/rest/v1/rpc/get_pin_user_credentials', 15000);

  // Multiple rapid requests (check stability)
  el.innerHTML += '<div><strong>--- Rapid fire (3x) ---</strong></div>';
  for (var i = 0; i < 3; i++) {
    await testFetch('Supabase #' + (i+1), SUPABASE_URL + '/rest/v1/', 15000);
  }

  el.innerHTML += '<div style="margin-top:12px"><strong>Navigator info:</strong> online=' + navigator.onLine + ', connection=' + (navigator.connection ? navigator.connection.effectiveType + ' downlink=' + navigator.connection.downlink + 'Mbps' : 'N/A') + '</div>';
}

function analyze() {
  var total = 0;
  var items = [];
  for (var i = 0; i < localStorage.length; i++) {
    var k = localStorage.key(i);
    var v = localStorage.getItem(k);
    var s = new Blob([v]).size;
    items.push({ k: k, s: s });
    total += s;
  }
  items.sort(function(a, b) { return b.s - a.s; });

  var html = '<div class="total">TOTAL: ' + (total / 1024 / 1024).toFixed(2) + ' MB / 5 MB (' + (total / 5242880 * 100).toFixed(1) + '%)</div>';
  items.forEach(function(x, i) {
    var sizeStr = x.s > 1024 ? (x.s / 1024).toFixed(1) + ' KB' : x.s + ' B';
    if (x.s > 1048576) sizeStr = (x.s / 1048576).toFixed(2) + ' MB';
    html += '<div class="item">' + (i + 1) + '. <strong>' + x.k + '</strong>: <span class="size">' + sizeStr + '</span></div>';
  });
  document.getElementById('output').innerHTML = html;
}

analyze();
</script>
</body>
</html>
