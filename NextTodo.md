# Next Sprint Tasks##  COMPLETED: Yield Percentage Implementation (Session 2025-12-05)### =ï¿½ SummaryImplemented yield percentage support for recipe components and preparation ingredients to accurately calculate costs accounting for product waste (peeling, trimming, etc.).### <ï¿½ What We Built**Feature:** Toggle "Account for Yield %" for each product in recipes/preparations- **Auto-enables** when product's yield < 100%- **Shows gross quantity** hint: `"Purchase: 200.0g (50% yield)"`- **Saves to database** via `use_yield_percentage` boolean column- **Live Cost Preview** correctly calculates costs with yield adjustment**Formula:** `grossQuantity = netQuantity / (yieldPercentage / 100)`**Example:**- Recipe needs: 100g banana (net)- Product yield: 65%- Gross quantity: 100g ï¿½ 0.65 = 154g- Cost: 154g ï¿½ price = **CORRECT** ---### = Bugs Fixed#### 1. **Vue Warning: `persistent-hint` expects Boolean****Problem:**```vue:persistent-hint="component.useYieldPercentage && component.componentType === 'product' &&component.componentId"```Returned `string` (UUID) instead of `boolean`, causing Vue warning.**Fix:** src/views/recipes/components/widgets/RecipeComponentsEditorWidget.vue:163```vue:persistent-hint="!!(component.useYieldPercentage && component.componentType === 'product' &&component.componentId)"```---#### 2. **Cost Preview Widget Not Showing****Problem:**`productsStore` and `recipesStore` were regular `let` variables, not reactive refs.Widget condition `v-if="estimatedCost.totalCost > 0"` always returned 0.**Fix:** src/views/recipes/components/widgets/RecipeCostPreviewWidget.vue:96-97```typescript// Before:let productsStore: any = nulllet recipesStore: any = null// After:const productsStore = ref<any>(null)const recipesStore = ref<any>(null)```Updated all references to use `.value`:- Line 127: `if (!productsStore.value || !recipesStore.value)`- Line 138: `productsStore.value?.getProductForRecipe(...)`- Line 150: `recipesStore.value?.getPreparationCostCalculation(...)`- Line 246-247, 256: `recipesStore.value?.preparations/recipes?.find(...)`---#### 3. **Missing `yieldPercentage` in ProductForRecipe****Problem:**`getProductForRecipe()` didn't return `yieldPercentage` field, so cost calculations couldn't access product's yield.**Fix:** src/stores/productsStore/productsStore.ts:279```typescriptreturn {  id: product.id,  name: product.name,  nameEn: product.nameEn || product.name,  baseUnit: product.baseUnit,  baseCostPerUnit: product.baseCostPerUnit,  yieldPercentage: product.yieldPercentage, //  NEW  category: product.category,  isActive: product.isActive  // ...}```---### =ï¿½ Files Modified#### Type Definitions1. **src/stores/recipes/types.ts**   - Line 134: Added `useYieldPercentage?: boolean` to `RecipeComponent`   - Line 22: Added `yieldPercentage?: number` to `ProductForRecipe`   - Line 88-90: Added `useYieldPercentage?: boolean` and `sortOrder?: number` to `PreparationIngredient`#### UI Components2. **src/views/recipes/components/widgets/RecipeComponentsEditorWidget.vue**   - Line 162-163: Fixed `persistent-hint` boolean conversion   - Line 201-224: Replaced large yield card with compact switch   - Line 635-678: Added helper functions:     - `getQuantityHint()` - Shows gross quantity in field hint     - `shouldShowYieldToggle()` - Shows switch only if yield < 100%     - `getProductYield()` - Gets product's yield percentage   - Line 605-612: Auto-enable yield toggle when product selected with yield < 100%   - Line 695: Load `yieldPercentage` from products store#### Cost Calculation3. **src/views/recipes/components/widgets/RecipeCostPreviewWidget.vue**   - Line 96-97: Changed stores to reactive refs   - Line 110-118: Updated `getStores()` to use `.value`   - Line 127-130: Added stores loaded check   - Line 138, 150: Updated to use `productsStore.value` and `recipesStore.value`   - Line 190-196: Added yield adjustment to `calculateProductCost()`:     ```typescript     if (component.useYieldPercentage && product.yieldPercentage) {       yieldPercentage = product.yieldPercentage       adjustedQuantity = baseQuantity / (yieldPercentage / 100)     }     ```   - Line 246-247, 256: Updated actual cost loading to use `.value`4. **src/stores/recipes/composables/useCostCalculation.ts**   - Line 85-98: Updated `calculateDirectCost()` to accept `useYield` parameter:     ```typescript     function calculateDirectCost(       quantity: number,       product: ProductForRecipe,       useYield: boolean = false     ): number {       let adjustedQuantity = quantity       if (useYield && product.yieldPercentage && product.yieldPercentage < 100) {         adjustedQuantity = quantity / (product.yieldPercentage / 100)       }       return adjustedQuantity * product.baseCostPerUnit     }     ```   - Line 418-422: Updated recipe cost calculation to pass `useYieldPercentage` flag#### Data Persistence5. **src/stores/productsStore/productsStore.ts**   - Line 279: Added `yieldPercentage` to `getProductForRecipe()` return value6. **src/stores/recipes/supabaseMappers.ts**   - Line 241: Added `use_yield_percentage` to `recipeComponentToSupabaseInsert()`   - Line 255: Added `useYieldPercentage` to `recipeComponentFromSupabase()`   - Line 124: Added `use_yield_percentage` to `preparationIngredientToSupabaseInsert()`   - Line 139: Added `useYieldPercentage` to `preparationIngredientFromSupabase()`---### =ï¿½ Database Changes#### DEV Database ( Applied via MCP)```sqlALTER TABLE recipe_componentsADD COLUMN use_yield_percentage BOOLEAN DEFAULT false;ALTER TABLE preparation_ingredientsADD COLUMN use_yield_percentage BOOLEAN DEFAULT false;-- Indexes for performanceCREATE INDEX idx_recipe_components_use_yieldON recipe_components(use_yield_percentage)WHERE use_yield_percentage = true;CREATE INDEX idx_preparation_ingredients_use_yieldON preparation_ingredients(use_yield_percentage)WHERE use_yield_percentage = true;```#### Production Database (ï¿½ PENDING - Manual Migration Required)**Migration file created:** `src/supabase/migrations/039_add_use_yield_percentage.sql`**TODO:** Apply to production via Supabase SQL Editor:1. Open: https://supabase.com/dashboard/project/bkntdcvzatawencxghob2. Go to SQL Editor3. Copy/paste content from `039_add_use_yield_percentage.sql`4. Run migration5. Verify: `NOTICE: Migration 039 completed successfully`---### <ï¿½ UI/UX Improvements**Before:**- Large tonal card with checkbox- Separate section for gross quantity- Always visible (even for yield = 100%)- Took up ~3 rows of vertical space**After:**- Compact switch (1 row)- Only shows if yield < 100%- Gross quantity in field hint: `"Purchase: 200.0g (50% yield)"`- ~70% less screen space---### >ï¿½ Testing Checklist- [x] UI shows yield toggle only for products with yield < 100%- [x] Toggle auto-enables when adding product with yield < 100%- [x] Gross quantity hint displays correctly under Quantity field- [x] Cost Preview widget shows correct cost with yield adjustment- [x] Save recipe/preparation persists `use_yield_percentage` to DB- [x] Load recipe/preparation restores `use_yield_percentage` from DB- [x] No Vue warnings in console- [x] Build completes successfully- [ ] **PENDING:** Production migration applied and verified---### =ï¿½ Notes for Next Session1. **Test on DEV:** Create several recipes with yield-enabled products, verify calculations2. **Apply to PROD:** Run migration `039_add_use_yield_percentage.sql` via Supabase SQL Editor3. **Verify PROD:** Check that columns exist and indexes created4. **Monitor:** Watch for any errors in production after deployment---### =Key Insights**Why Yield Matters:**- Products lose weight during preparation (peeling, trimming, bones, etc.)- Example: 1kg whole chicken ï¿½ 600g usable meat (60% yield)- Without yield adjustment: Recipe shows 600g cost when actually need 1kg- With yield adjustment: Correctly calculates cost for 1kg purchase**Architecture Decision:**- Store `useYieldPercentage` as boolean (not the percentage value itself)- Always read percentage from `products.yieldPercentage` (single source of truth)- This prevents data inconsistency if product yield changes**Backward Compatibility:**- Existing recipes default to `use_yield_percentage = false`- No automatic migration of existing data- New recipes auto-enable if yield < 100%---## =ï¿½ Next Tasks### High Priority- [ ] Apply production migration `039_add_use_yield_percentage.sql`- [ ] Test yield calculations on production data- [ ] Update any existing recipes that should use yield### Medium Priority- [ ] Add yield percentage display in recipe cost breakdown- [ ] Consider adding "Why is cost higher?" tooltip explaining yield- [ ] Add yield percentage to batch calculations (if applicable)### Low Priority- [ ] Analytics: Track which products most commonly use yield adjustment- [ ] Bulk edit: Enable yield for all recipes using specific products