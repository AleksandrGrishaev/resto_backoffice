# PLN –ö–∞—Å—Å–æ–≤—ã–π –º–µ—Ç–æ–¥

–î–∞–≤–∞–π –µ—â–µ –≤–Ω–µ—Å–µ–º –≤ PLN –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É, —Ç–æ –µ—Å—Ç—å —É –Ω–∞—Å –±—É–¥—É—Ç –¥–≤–∞ –º–µ—Ç–æ–¥–∞ –ø–æ–¥—Å—á–µ—Ç–∞
—Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã GOGS + —Å–ø–∏—Å–∞–Ω–∏—è –∏ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º –∏ –ø–æ–¥—Å—á–µ—Ç
–∫—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤. –ü–æ–Ω–∏–º–∞–µ—à—å –æ —á–µ–º —è? –ú–æ–∂–µ–º —Å—á–∏—Ç–∞—Ç—å
—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–∫–æ–ª—å–∫–æ —É—à–ª–æ, –∞ –º–æ–∂–µ–º —Å—á–∏—Ç–∞—Ç—å —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–ª–∞—Ç–∏–ª–∏ –∏ —Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤
–±—ã–ª–æ –Ω–∞ –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ –∏ —Å–∫–æ–ª—å–∫–æ –Ω–∞ –∫–æ–Ω–µ—Ü. –ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å–ª–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å?

‚è∫ –û—Ç–ª–∏—á–Ω–æ! –ü–æ–Ω–∏–º–∞—é –æ —á–µ–º —Ç—ã. –≠—Ç–æ –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –º–µ—Ç–æ–¥–∞ —Ä–∞—Å—á–µ—Ç–∞ Food Cost:

–î–≤–∞ –º–µ—Ç–æ–¥–∞ —Ä–∞—Å—á–µ—Ç–∞ Food Cost –≤ P&L

–ú–µ—Ç–æ–¥ 1: Accrual Basis (–ú–µ—Ç–æ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è) - –¢–ï–ö–£–©–ò–ô

Food Cost = COGS (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥–∞–∂–∏) + –°–ø–∏—Å–∞–Ω–∏—è

- –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- –°—á–∏—Ç–∞–µ—Ç –∫–æ–≥–¥–∞ –ø—Ä–æ–¥—É–∫—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã
- –¢–æ—á–Ω–µ–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂

–ú–µ—Ç–æ–¥ 2: Cash Basis + Inventory Changes (–ö–∞—Å—Å–æ–≤—ã–π –º–µ—Ç–æ–¥)

Food Cost = Purchases (–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º) + Opening Inventory - Closing
Inventory
–∏–ª–∏
Food Cost = Purchases + (Opening Inventory - Closing Inventory)

- –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∞—Å–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –¥–µ–Ω–µ–≥

---

–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ

–î–∞–Ω–Ω—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥:

- Opening Inventory (–Ω–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫): Rp 5,000,000
- Purchases (–∑–∞–∫—É–ø–∫–∏ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤): Rp 10,000,000
- Closing Inventory (–∫–æ–Ω–µ—á–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫): Rp 4,000,000

–ú–µ—Ç–æ–¥ 1 (Accrual - —Ç–µ–∫—É—â–∏–π):
COGS –æ—Ç –ø—Ä–æ–¥–∞–∂ = Rp 8,500,000
–°–ø–∏—Å–∞–Ω–∏—è = Rp 2,156,735
Total Food Cost = Rp 10,656,735

–ú–µ—Ç–æ–¥ 2 (Cash Basis):
Purchases = Rp 10,000,000

- Opening Inventory = Rp 5,000,000

* Closing Inventory = Rp 4,000,000
  Total Food Cost = Rp 11,000,000

–†–∞–∑–Ω–∏—Ü–∞: Rp 343,265 - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å:

- –ö—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å (accounts payable)
- –¢–æ–≤–∞—Ä—ã –≤ –ø—É—Ç–∏
- –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –≤ —É—á–µ—Ç–µ

---

–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

‚úÖ –õ–ï–ì–ö–û - –£ –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –ø–æ—á—Ç–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!

–ß—Ç–æ —É–∂–µ –µ—Å—Ç—å:

1. ‚úÖ storage_batches - —Ç–µ–∫—É—â–∏–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (Closing Inventory)
2. ‚úÖ storage_operations - –ø—Ä–∏—Ö–æ–¥—ã –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (Purchases)
3. ‚úÖ supplierstore_receipts + supplierstore_receipt_items - –¥–µ—Ç–∞–ª—å–Ω—ã–µ
   –ø—Ä–∏—Ö–æ–¥—ã
4. ‚úÖ counteragents - –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏
5. ‚úÖ transactions - –æ–ø–ª–∞—Ç—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º

–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. ‚è≥ –ú–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ Opening Inventory (–æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞)
2. ‚è≥ –ú–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ Purchases (–∑–∞–∫—É–ø–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥)
3. ‚è≥ –ú–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ Accounts Payable (–∫—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å)
4. ‚è≥ Toggle –≤ P&L Report –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞ —Ä–∞—Å—á–µ—Ç–∞

---

–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

Step 1: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã —Ä–∞—Å—á–µ—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è

File: src/stores/analytics/inventoryValuationStore.ts (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!)

// –ú–µ—Ç–æ–¥ —É–∂–µ –µ—Å—Ç—å! getInventoryValue()
// –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞—Ç:

async getInventoryValueAtDate(date: string): Promise<number> {
// –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö storage_batches –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É
// WHERE created_at <= date AND (consumed_at > date OR consumed_at IS NULL)
}

Step 2: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ –∑–∞–∫—É–ø–æ–∫

File: src/stores/analytics/purchasesStore.ts (–Ω–æ–≤—ã–π!)

async getPurchasesForPeriod(from: string, to: string): Promise<{
totalPurchases: number
paidAmount: number
unpaidAmount: number // –ö—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å
bySupplier: Array<{
supplierId: string
supplierName: string
totalPurchases: number
paidAmount: number
unpaidAmount: number
}>
}> {
// Query supplierstore_receipts –∑–∞ –ø–µ—Ä–∏–æ–¥
// Join —Å transactions –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–ø–ª–∞—Ç
}

Step 3: –û–±–Ω–æ–≤–∏—Ç—å P&L Report Store

File: src/stores/analytics/plReportStore.ts

// –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ PLReport:
interface PLReport {
// ... existing fields ...

    foodCostCalculationMethod: 'accrual' | 'cash' // NEW

    // –ú–µ—Ç–æ–¥ 1 (Accrual) - —Ç–µ–∫—É—â–∏–π
    accrualFoodCost: {
      cogs: number
      adjustments: number
      total: number
    }

    // –ú–µ—Ç–æ–¥ 2 (Cash Basis) - NEW
    cashFoodCost: {
      openingInventory: number
      purchases: number
      closingInventory: number
      total: number
      accountsPayable: number
    }

}

Step 4: –û–±–Ω–æ–≤–∏—Ç—å UI

File: src/views/backoffice/analytics/PLReportView.vue

  <!-- –î–æ–±–∞–≤–∏—Ç—å toggle –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞ -->

<v-switch
v-model="useAccrualMethod"
label="Calculation Method"
:true-value="true"
:false-value="false"
color="primary"

>

    <template #label>
      <span v-if="useAccrualMethod">Accrual Basis (COGS + Write-offs)</span>
      <span v-else>Cash Basis (Purchases + Inventory Changes)</span>
    </template>

  </v-switch>

  <!-- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–±–∞ –º–µ—Ç–æ–¥–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è -->
  <v-row>
    <v-col cols="6">
      <v-card title="Method 1: Accrual Basis">
        <template #text>
          <div>COGS: {{ formatIDR(report.accrualFoodCost.cogs) }}</div>
          <div>Adjustments: {{ formatIDR(report.accrualFoodCost.adjustments)
  }}</div>
          <div><strong>Total: {{ formatIDR(report.accrualFoodCost.total)
  }}</strong></div>
        </template>
      </v-card>
    </v-col>

    <v-col cols="6">
      <v-card title="Method 2: Cash Basis">
        <template #text>
          <div>Opening Inventory: {{

formatIDR(report.cashFoodCost.openingInventory) }}</div>

<div>+ Purchases: {{ formatIDR(report.cashFoodCost.purchases)
  }}</div>
<div>- Closing Inventory: {{
  formatIDR(report.cashFoodCost.closingInventory) }}</div>
<div><strong>Total: {{ formatIDR(report.cashFoodCost.total)
  }}</strong></div>
<v-divider class="my-2" />
<div class="text-warning">Accounts Payable: {{
  formatIDR(report.cashFoodCost.accountsPayable) }}</div>
</template>
</v-card>
</v-col>
</v-row>

---

–û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

| –ó–∞–¥–∞—á–∞ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –í—Ä–µ–º—è | –ü—Ä–∏—á–∏–Ω–∞
|
|---------------------------|-----------|-------|----------------------------
--|
| getInventoryValueAtDate() | üü¢ –õ–µ–≥–∫–æ | 1-2 —á | SQL query —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ
–¥–∞—Ç–µ |
| getPurchasesForPeriod() | üü° –°—Ä–µ–¥–Ω–µ | 2-3 —á | Join –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü
|
| –û–±–Ω–æ–≤–∏—Ç—å plReportStore | üü¢ –õ–µ–≥–∫–æ | 1-2 —á | –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è
|
| UI Toggle + Display | üü¢ –õ–µ–≥–∫–æ | 1-2 —á | Vuetify components
|
| TOTAL | üü¢ –õ–µ–≥–∫–æ | 5-9 —á | –î–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å!
|

---

–ü–æ–ª—å–∑–∞ –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

1. Cash Flow Analysis - –≤–∏–¥–Ω–æ —Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø–ª–∞—á–µ–Ω–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º
2. Accounts Payable Tracking - –∫–æ–Ω—Ç—Ä–æ–ª—å –∫—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏
3. Inventory Turnover - –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∫–ª–∞–¥
4. Fraud Detection - —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –º–µ–∂–¥—É –º–µ—Ç–æ–¥–∞–º–∏ –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã
5. Tax Compliance - –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–ª–æ–≥–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã —Ç—Ä–µ–±—É—é—Ç –∫–∞—Å—Å–æ–≤—ã–π –º–µ—Ç–æ–¥

üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—è–≤—è—Ç—Å—è:

- Inventory Turnover Ratio = COGS / Average Inventory
- Days Inventory Outstanding = (Average Inventory / COGS) √ó Days
- Accounts Payable Days = (Accounts Payable / Purchases) √ó Days

---

–í–æ–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º

1. –ö–∞–∫–æ–π –º–µ—Ç–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?

   - Accrual (—Ç–µ–∫—É—â–∏–π) - –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   - Cash - –¥–ª—è cash flow planning

2. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–±–∞ –º–µ—Ç–æ–¥–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏–ª–∏ toggle?

   - –†–µ–∫–æ–º–µ–Ω–¥—É—é: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–±–∞, highlight —Ä–∞–∑–Ω–∏—Ü—É

3. –ö–∞–∫ —É—á–∏—Ç—ã–≤–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ –æ–ø–ª–∞—Ç—ã?

   - –ï—Å–ª–∏ –ø–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ Rp 10M, –æ–ø–ª–∞—á–µ–Ω–æ Rp 7M ‚Üí Accounts Payable = Rp 3M

4. –ö–∞–∫–æ–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è Opening/Closing Inventory?

   - –¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥ P&L (from-to dates)

–•–æ—á–µ—à—å –Ω–∞—á–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Å–ª–æ–∂–Ω–æ –∏ –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è
–±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏!

# –¥—Ä—É–≥–∏–µ –ø—Ä–∞–≤–∫–∏

## <ÔøΩ SPRINT 1: UUID Migration for Account Store

**Priority:** HIGH
**Complexity:** LARGE REFACTORING
**Risk Level:** HIGH (affects core financial data)
**Estimated Effort:** 3-5 days

### =ÔøΩ Overview

Currently, Account Store uses **string-based IDs** like `'acc_1'`, `'acc_2'`, etc. This causes:

- L ID collisions risk
- L Hardcoded references throughout codebase
- L Difficult to maintain and scale
- L Non-standard approach (Supabase uses UUID by default)

**Goal:** Migrate all account IDs to **UUID format** and refactor all references.

---

### =

Phase 1: Discovery & Impact Analysis

#### 1.1 Find All Account ID References

**Search patterns:**

```bash
# Hardcoded account IDs
grep -r "acc_1" src/
grep -r "acc_2" src/
grep -r "'acc_" src/
grep -r '"acc_' src/

# Constants
grep -r "POS_CASH_ACCOUNT_ID" src/

# Type references
grep -r "accountId" src/
grep -r "assignedToAccount" src/
```

**Expected locations:**

- `src/stores/account/types.ts` - POS_CASH_ACCOUNT_ID constant
- `src/stores/account/store.ts` - account references
- `src/stores/account/service.ts` - account operations
- `src/stores/pos/` - POS cash account references
- `src/views/backoffice/accounts/` - UI components
- `src/views/backoffice/analytics/` - P&L reports
- `src/stores/counteragents/` - payment account assignments
- Database seed scripts (if any)

#### 1.2 Document Current Account Structure

```typescript
// CURRENT (String-based)
interface Account {
  id: string // 'acc_1', 'acc_2', etc.
  name: string
  type: AccountType
  balance: number
  // ...
}

// TARGET (UUID-based)
interface Account {
  id: string // UUID format: '550e8400-e29b-41d4-a716-446655440000'
  name: string
  type: AccountType
  balance: number
  // ...
}
```

---

### =ÔøΩ Phase 2: Database Migration

#### 2.1 Create Migration File

**File:** `src/supabase/migrations/XXX_migrate_accounts_to_uuid.sql`

```sql
-- Migration: XXX_migrate_accounts_to_uuid
-- Description: Convert account IDs from string format to UUID
-- Date: 2025-12-01
-- Author: Kitchen App Team

-- ÔøΩ CRITICAL: This is a DESTRUCTIVE migration
-- Backup database before running!

-- STEP 1: Create mapping table for old -> new IDs
CREATE TABLE IF NOT EXISTS account_id_mapping (
  old_id TEXT PRIMARY KEY,
  new_id UUID NOT NULL UNIQUE,
  account_name TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- STEP 2: Generate UUIDs for existing accounts
INSERT INTO account_id_mapping (old_id, new_id, account_name)
SELECT
  id,
  gen_random_uuid(),
  name
FROM accounts
ON CONFLICT (old_id) DO NOTHING;

-- STEP 3: Add new UUID column to accounts table
ALTER TABLE accounts ADD COLUMN IF NOT EXISTS id_new UUID;

-- STEP 4: Update accounts with new UUIDs
UPDATE accounts a
SET id_new = m.new_id
FROM account_id_mapping m
WHERE a.id = m.old_id;

-- STEP 5: Update foreign keys in transactions table
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS account_id_new UUID;

UPDATE transactions t
SET account_id_new = m.new_id
FROM account_id_mapping m
WHERE t.account_id = m.old_id;

-- STEP 6: Update foreign keys in pending_payments table
ALTER TABLE pending_payments ADD COLUMN IF NOT EXISTS assigned_to_account_new UUID;

UPDATE pending_payments p
SET assigned_to_account_new = m.new_id
FROM account_id_mapping m
WHERE p.assigned_to_account = m.old_id;

-- STEP 7: Verify data integrity
-- Check all accounts have new UUIDs
SELECT 'Accounts without UUID' AS check_name, COUNT(*) AS count
FROM accounts
WHERE id_new IS NULL;

-- Check all transactions mapped
SELECT 'Transactions without UUID' AS check_name, COUNT(*) AS count
FROM transactions
WHERE account_id_new IS NULL AND account_id IS NOT NULL;

-- Check all payments mapped
SELECT 'Payments without UUID' AS check_name, COUNT(*) AS count
FROM pending_payments
WHERE assigned_to_account_new IS NULL AND assigned_to_account IS NOT NULL;

-- STEP 8: Switch to new IDs (CRITICAL STEP)
-- ÔøΩ ONLY RUN AFTER VERIFYING DATA INTEGRITY!

-- Rename old columns
ALTER TABLE accounts RENAME COLUMN id TO id_old;
ALTER TABLE accounts RENAME COLUMN id_new TO id;

ALTER TABLE transactions RENAME COLUMN account_id TO account_id_old;
ALTER TABLE transactions RENAME COLUMN account_id_new TO account_id;

ALTER TABLE pending_payments RENAME COLUMN assigned_to_account TO assigned_to_account_old;
ALTER TABLE pending_payments RENAME COLUMN assigned_to_account_new TO assigned_to_account;

-- STEP 9: Update primary key and constraints
ALTER TABLE accounts DROP CONSTRAINT accounts_pkey;
ALTER TABLE accounts ADD PRIMARY KEY (id);

-- STEP 10: Add foreign key constraints
ALTER TABLE transactions
  ADD CONSTRAINT fk_transactions_account
  FOREIGN KEY (account_id)
  REFERENCES accounts(id)
  ON DELETE RESTRICT;

ALTER TABLE pending_payments
  ADD CONSTRAINT fk_pending_payments_account
  FOREIGN KEY (assigned_to_account)
  REFERENCES accounts(id)
  ON DELETE SET NULL;

-- STEP 11: Create indices for performance
CREATE INDEX IF NOT EXISTS idx_transactions_account_id ON transactions(account_id);
CREATE INDEX IF NOT EXISTS idx_pending_payments_account_id ON pending_payments(assigned_to_account);

-- STEP 12: Keep mapping table for reference (don't drop it)
-- This allows rollback and debugging
COMMENT ON TABLE account_id_mapping IS 'Mapping table for account ID migration from string to UUID. Keep for reference and potential rollback.';

-- STEP 13: (Optional) Drop old columns after verification period
-- ÔøΩ ONLY RUN AFTER 1+ WEEK OF STABLE OPERATION
-- ALTER TABLE accounts DROP COLUMN id_old;
-- ALTER TABLE transactions DROP COLUMN account_id_old;
-- ALTER TABLE pending_payments DROP COLUMN assigned_to_account_old;
```

#### 2.2 Create Rollback Migration

**File:** `src/supabase/migrations/XXX_rollback_accounts_uuid.sql`

```sql
-- Rollback Migration: XXX_rollback_accounts_uuid
-- Description: Rollback UUID migration and restore string IDs
-- ÔøΩ EMERGENCY USE ONLY

-- Restore old columns as primary
ALTER TABLE accounts RENAME COLUMN id TO id_uuid;
ALTER TABLE accounts RENAME COLUMN id_old TO id;

ALTER TABLE transactions RENAME COLUMN account_id TO account_id_uuid;
ALTER TABLE transactions RENAME COLUMN account_id_old TO account_id;

ALTER TABLE pending_payments RENAME COLUMN assigned_to_account TO assigned_to_account_uuid;
ALTER TABLE pending_payments RENAME COLUMN assigned_to_account_old TO assigned_to_account;

-- Restore primary key
ALTER TABLE accounts DROP CONSTRAINT accounts_pkey;
ALTER TABLE accounts ADD PRIMARY KEY (id);

-- Drop foreign keys
ALTER TABLE transactions DROP CONSTRAINT IF EXISTS fk_transactions_account;
ALTER TABLE pending_payments DROP CONSTRAINT IF EXISTS fk_pending_payments_account;
```

---

### =ÔøΩ Phase 3: Code Refactoring

#### 3.1 Update Constants

**File:** `src/stores/account/types.ts`

```typescript
// BEFORE:
export const POS_CASH_ACCOUNT_ID = 'acc_1'

// AFTER: Store mapping in config or environment
// Option 1: Create config file
// src/config/accounts.ts
export const ACCOUNT_MAPPINGS = {
  POS_CASH: '550e8400-e29b-41d4-a716-446655440000', // UUID from migration
  BANK_BNI: '660e8400-e29b-41d4-a716-446655440001',
  RESERVE_CASH: '770e8400-e29b-41d4-a716-446655440002'
} as const

// Option 2: Load from Supabase at runtime
// More flexible but requires async initialization
export let POS_CASH_ACCOUNT_ID: string | null = null

export async function initializeAccountConstants() {
  const { data } = await supabase.from('accounts').select('id').eq('name', 'A=>2=0O :0AA0').single()

  if (data) {
    POS_CASH_ACCOUNT_ID = data.id
  }
}
```

#### 3.2 Update Account Service

**File:** `src/stores/account/service.ts`

```typescript
// No changes needed - service already uses `id: string`
// UUID is just a string format

//  Verify these methods work with UUID:
async getById(id: string): Promise<Account | null>
async create(data: ...): Promise<Account>
async update(id: string, data: ...): Promise<void>
```

#### 3.3 Update Supabase Mappers

**File:** `src/stores/account/supabaseMappers.ts`

```typescript
// Verify UUID handling in mappers
export function accountFromSupabase(data: any): Account {
  return {
    id: data.id, // Should be UUID string
    name: data.name,
    type: data.type as AccountType,
    balance: data.balance
    // ...
  }
}

// Add validation helper
export function isValidUUID(id: string): boolean {
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i
  return uuidRegex.test(id)
}
```

#### 3.4 Update Components

**Files to update:**

- `src/views/backoffice/accounts/AccountsView.vue`
- `src/views/backoffice/accounts/components/*.vue`
- `src/views/pos/` (POS cash account references)
- Any component with hardcoded `'acc_1'`

**Search and replace pattern:**

```typescript
// BEFORE:
if (accountId === 'acc_1') { ... }

// AFTER:
import { ACCOUNT_MAPPINGS } from '@/config/accounts'
if (accountId === ACCOUNT_MAPPINGS.POS_CASH) { ... }

// OR (if using runtime loading):
import { POS_CASH_ACCOUNT_ID } from '@/stores/account/types'
if (accountId === POS_CASH_ACCOUNT_ID) { ... }
```

#### 3.5 Update Seed Scripts

**Files:**

- `src/scripts/seed-accounts.ts` (if exists)
- Any test data generation scripts

```typescript
// BEFORE:
const accounts = [
  { id: 'acc_1', name: 'A=>2=0O :0AA0', ... },
  { id: 'acc_2', name: 'BNI Bank', ... },
]

// AFTER:
import { v4 as uuidv4 } from 'uuid'

const accounts = [
  { id: uuidv4(), name: 'A=>2=0O :0AA0', ... },
  { id: uuidv4(), name: 'BNI Bank', ... },
]

// OR use fixed UUIDs from migration:
const accounts = [
  { id: '550e8400-e29b-41d4-a716-446655440000', name: 'A=>2=0O :0AA0', ... },
  { id: '660e8400-e29b-41d4-a716-446655440001', name: 'BNI Bank', ... },
]
```

---

### >ÔøΩ Phase 4: Testing

#### 4.1 Unit Tests

```typescript
// Test UUID validation
describe('UUID Validation', () => {
  it('should accept valid UUID', () => {
    expect(isValidUUID('550e8400-e29b-41d4-a716-446655440000')).toBe(true)
  })

  it('should reject old string IDs', () => {
    expect(isValidUUID('acc_1')).toBe(false)
  })
})

// Test account operations with UUID
describe('Account Service', () => {
  it('should create account with UUID', async () => {
    const account = await accountService.create({ ... })
    expect(isValidUUID(account.id)).toBe(true)
  })
})
```

#### 4.2 Integration Tests

-  Create account and verify UUID format
-  Create transaction and verify account reference
-  Create payment and verify account assignment
-  Transfer between accounts using UUIDs
-  POS operations with UUID-based cash account
-  P&L Report with UUID-based transactions

#### 4.3 Manual Testing Checklist

- [ ] Open Accounts view - all accounts load correctly
- [ ] Create new account - generates UUID
- [ ] Create transaction - account reference works
- [ ] Create payment - account assignment works
- [ ] Open POS - cash account identified correctly
- [ ] Generate P&L Report - transactions load correctly
- [ ] Transfer between accounts - both accounts updated
- [ ] Check database directly - verify UUID format

---

### =ÔøΩ Phase 5: Deployment

#### 5.1 Pre-Deployment

1.  **Backup production database**

   ```bash
   # Using Supabase CLI
   npx supabase db dump > backup_before_uuid_migration.sql
   ```

2.  **Test migration on staging/dev database**

   ```bash
   npx supabase db reset --db-url <dev-db-url>
   npx supabase migration up
   ```

3.  **Verify data integrity on staging**
   - Check account count matches
   - Check all transactions have valid account references
   - Check all payments have valid account assignments

#### 5.2 Deployment Steps

1. **Announce maintenance window** (30-60 minutes)
2. **Stop application** (prevent new writes)
3. **Run migration** on production database
4. **Verify data integrity** (run checks from migration)
5. **Deploy updated code** with UUID support
6. **Smoke test** critical paths (create transaction, POS operations)
7. **Resume application**
8. **Monitor logs** for UUID-related errors

#### 5.3 Post-Deployment

1. **Keep mapping table** for 1-2 weeks
2. **Monitor error logs** for hardcoded ID references
3. **After stability period** - drop old columns (Step 13 in migration)

---

### ÔøΩ Risks & Mitigation

| Risk                        | Impact   | Probability | Mitigation                                               |
| --------------------------- | -------- | ----------- | -------------------------------------------------------- |
| Data loss during migration  | CRITICAL | LOW         | Full database backup, test on staging first              |
| Missed hardcoded references | HIGH     | MEDIUM      | Comprehensive grep search, runtime validation            |
| Performance degradation     | MEDIUM   | LOW         | Add indices on UUID columns, benchmark before/after      |
| POS operations break        | HIGH     | MEDIUM      | Extensive testing of POS cash account detection          |
| Rollback complexity         | HIGH     | LOW         | Prepare rollback migration, keep old columns temporarily |

---

### =ÔøΩ Notes

- **UUID format:** Use PostgreSQL `gen_random_uuid()` or `uuid-ossp` extension
- **Backwards compatibility:** Keep old columns for 1-2 weeks for rollback
- **Mapping table:** NEVER delete - useful for debugging and data analysis
- **Testing:** Focus on POS operations - most critical for business
- **Documentation:** Update CLAUDE.md with new account ID format

## –ß—Ç–æ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ —Ç–∞–∫?
