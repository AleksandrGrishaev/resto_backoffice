# ТЗ: Синхронизация схемы DEV и PROD баз данных

## Проблема

Обнаружено расхождение схем между DEV и PROD базами данных:

| Колонка               | DEV     | PROD   |
| --------------------- | ------- | ------ |
| `products.deleted_at` | ✅ Есть | ❌ Нет |

## Контекст

- **DEV база**: `fjkfckjpnbcyuknsnchy.supabase.co`
- **PROD база**: `bkntdcvzatawencxghob.supabase.co`
- Расхождение обнаружено при применении миграции `083_add_last_counted_at_to_products.sql`

## Задачи

### 1. Аудит расхождений

- [ ] Сравнить полную схему DEV и PROD
- [ ] Выявить все отличия в таблицах, колонках, индексах, функциях
- [ ] Составить список расхождений

### 2. Решение по `deleted_at`

**Вариант A: Добавить soft delete в PROD**

```sql
ALTER TABLE products
ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP WITH TIME ZONE;

CREATE INDEX IF NOT EXISTS idx_products_deleted_at
ON products(deleted_at) WHERE deleted_at IS NULL;
```

Плюсы:

- Синхронизация баз
- Soft delete для безопасного удаления продуктов

Минусы:

- Нужно обновить все запросы в коде добавив `WHERE deleted_at IS NULL`
- Потенциальные проблемы с производительностью без правильных индексов

**Вариант B: Убрать soft delete из DEV**

- Откатить миграцию с `deleted_at` в DEV
- Использовать `is_active = false` вместо soft delete

Плюсы:

- Проще
- Меньше изменений в коде

Минусы:

- Потеря функциональности soft delete

### 3. Создание миграции синхронизации

- [ ] Создать миграцию для выбранного варианта
- [ ] Протестировать на DEV
- [ ] Применить на PROD

### 4. Процесс синхронизации баз (на будущее)

- [ ] Настроить процесс регулярной проверки схем
- [ ] Документировать порядок применения миграций

## Приоритет

Средний - базы работают, но расхождение может вызвать проблемы при будущих миграциях.

## Связанные файлы

- `/src/supabase/migrations/083_add_last_counted_at_to_products.sql` - миграция где обнаружена проблема
- `.mcp.json` - конфигурация MCP (переключение между базами)

## Дата обнаружения

2025-01-01
