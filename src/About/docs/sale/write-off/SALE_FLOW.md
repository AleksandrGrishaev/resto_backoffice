# Sale Flow Documentation - –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–∞–∂–∏ –∏ —Å–ø–∏—Å–∞–Ω–∏—è

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞](#–æ–±–∑–æ—Ä-–ø—Ä–æ—Ü–µ—Å—Å–∞)
2. [–≠—Ç–∞–ø 1: –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (POS)](#—ç—Ç–∞–ø-1-–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ-–∑–∞–∫–∞–∑–∞-pos)
3. [–≠—Ç–∞–ø 2: –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞](#—ç—Ç–∞–ø-2-–æ–ø–ª–∞—Ç–∞-–∑–∞–∫–∞–∑–∞)
4. [–≠—Ç–∞–ø 3: –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–æ–¥–∞–∂–∏](#—ç—Ç–∞–ø-3-–∑–∞–ø–∏—Å—å-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏-–ø—Ä–æ–¥–∞–∂–∏)
5. [–≠—Ç–∞–ø 4: –°–ø–∏—Å–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤](#—ç—Ç–∞–ø-4-—Å–ø–∏—Å–∞–Ω–∏–µ-–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤)
6. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-–¥–µ—Ç–∞–ª–∏)
7. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)

---

## –û–±–∑–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–¥–∞–∂–∏ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 4 —ç—Ç–∞–ø–æ–≤:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   POS        ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Payment    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    Sales     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Write-Off   ‚îÇ
‚îÇ   Order      ‚îÇ     ‚îÇ   Processing ‚îÇ     ‚îÇ  Recording   ‚îÇ     ‚îÇ   Inventory  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  –°–æ–∑–¥–∞–Ω–∏–µ           –û–ø–ª–∞—Ç–∞              –£—á–µ—Ç –ø—Ä–æ–¥–∞–∂         –°–ø–∏—Å–∞–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞
  –∑–∞–∫–∞–∑–∞             —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏          + —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å      FIFO + negative
```

**–í—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è:**

- **POS Order**: –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞)
- **Payment**: 1-2 —Å–µ–∫ (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞)
- **Sales Recording**: 2-3 —Å–µ–∫ (—Ä–∞—Å—á–µ—Ç COGS + –∑–∞–ø–∏—Å—å –≤ –ë–î)
- **Write-Off**: 3-5 —Å–µ–∫ (–¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è + FIFO allocation + negative batches)

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~6-11 —Å–µ–∫—É–Ω–¥

---

## –≠—Ç–∞–ø 1: –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (POS)

### –§–∞–π–ª—ã:

- `src/stores/pos/orders/ordersStore.ts`
- `src/stores/pos/tables/tablesStore.ts`
- `src/views/pos/order/OrderSection.vue`

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–æ–ª/—Ç–∏–ø –∑–∞–∫–∞–∑–∞**

   - –¢–∏–ø: `dine-in`, `takeaway`, `delivery`
   - –î–ª—è `dine-in` –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å—Ç–æ–ª –∏–∑ `tablesStore`

2. **–î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –º–µ–Ω—é**

   ```typescript
   order.items.push({
     menuItemId: '1880d1c2-...',
     variantId: 'f2c05dbe-...',
     name: 'Test',
     variantName: 'Dragon',
     quantity: 1,
     price: 100000,
     discounts: []
   })
   ```

3. **–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–∫–∞–∑ –≤ ordersStore**
   ```typescript
   ordersStore.createOrder({
     tableId?: string,
     orderType: 'dine-in' | 'takeaway' | 'delivery',
     items: OrderItem[],
     status: 'pending'
   })
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- Order —Å–æ–∑–¥–∞–Ω —Å `status: 'pending'`
- Order —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage (offline-first)
- UI –æ–±–Ω–æ–≤–ª–µ–Ω

---

## –≠—Ç–∞–ø 2: –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞

### –§–∞–π–ª—ã:

- `src/stores/pos/payments/paymentsStore.ts`
- `src/views/pos/order/dialogs/PaymentDialog.vue`

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "Pay"**

   - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è `PaymentDialog`
   - –í—ã–±–∏—Ä–∞–µ—Ç –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã: `cash`, `card`, `qr`

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞**

   ```typescript
   // Simple payment (–æ–¥–∏–Ω –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã)
   paymentsStore.processSimplePayment({
     orderId: order.id,
     amount: order.totalAmount,
     paymentMethod: 'cash',
     tendered: 150000
   })

   // Multiple payments (–Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤)
   paymentsStore.processMultiplePayments({
     orderId: order.id,
     payments: [
       { method: 'cash', amount: 50000 },
       { method: 'card', amount: 50000 }
     ]
   })
   ```

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞**
   - Order status: `pending` ‚Üí `paid`
   - Payment record —Å–æ–∑–¥–∞–Ω
   - –ï—Å–ª–∏ `dine-in`: Table status: `occupied` ‚Üí `available`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- Payment —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î (`payments` table)
- Order –æ–±–Ω–æ–≤–ª–µ–Ω (`orders` table)
- –°–¥–∞—á–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ (–¥–ª—è cash)

---

## –≠—Ç–∞–ø 3: –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–æ–¥–∞–∂–∏

### –§–∞–π–ª—ã:

- `src/stores/sales/salesStore.ts`
- `src/stores/sales/composables/useActualCostCalculation.ts`
- `src/stores/sales/composables/useProfitCalculation.ts`

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

### 3.1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```typescript
salesStore.recordSalesTransaction({
  orderId: order.id,
  items: order.items,
  totalRevenue: order.totalAmount,
  paymentMethods: ['cash'],
  shiftId: currentShift.id
})
```

### 3.2. –†–∞—Å—á–µ—Ç –§–ê–ö–¢–ò–ß–ï–°–ö–û–ô —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (FIFO)

**–§–∞–π–ª:** `src/stores/sales/composables/useActualCostCalculation.ts`

```typescript
const { calculateActualCost } = useActualCostCalculation()

for (const item of orderItems) {
  // Get menu item variant
  const variant = menuStore.getVariant(item.menuItemId, item.variantId)

  // variant.composition = [
  //   { type: 'preparation', id: 'ba109...', quantity: 20, unit: 'gram' },
  //   { type: 'product', id: '5212...', quantity: 5, unit: 'piece' }
  // ]

  let itemCost = 0

  for (const component of variant.composition) {
    if (component.type === 'product') {
      // Allocate from product batches (FIFO)
      const result = allocateFromProductBatches(component.id, component.quantity, department)
      itemCost += result.totalCost
    }

    if (component.type === 'preparation') {
      // Allocate from preparation batches (FIFO)
      const result = allocateFromPreparationBatches(component.id, component.quantity, department)
      itemCost += result.totalCost
    }
  }

  totalCost += itemCost
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ FIFO allocation:**

```typescript
// preparationStore.allocateBatches()
function allocateFromPreparationBatches(preparationId, quantity, department) {
  // 1. Get active batches (INCLUDING negative batches!)
  const batches = preparationStore.batches
    .filter(
      b =>
        b.preparationId === preparationId &&
        b.department === department &&
        b.isActive &&
        b.currentQuantity !== 0 // ‚Üê –í–∫–ª—é—á–∞—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ!
    )
    .sort((a, b) => new Date(a.productionDate).getTime() - new Date(b.productionDate).getTime())

  // 2. Allocate FIFO
  let remaining = quantity
  let totalCost = 0
  const allocations = []

  for (const batch of batches) {
    if (remaining <= 0) break

    const allocated = Math.min(remaining, batch.currentQuantity)
    totalCost += allocated * batch.costPerUnit

    allocations.push({
      batchId: batch.id,
      quantity: allocated,
      cost: batch.costPerUnit
    })

    remaining -= allocated
  }

  return { totalCost, allocations, deficit: remaining }
}
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ **–ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç write-off**!

- –≠—Ç–æ —Ç–æ–ª—å–∫–æ **—Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏** –¥–ª—è profit calculation
- Batches **—á–∏—Ç–∞—é—Ç—Å—è**, –Ω–æ **–Ω–µ –∏–∑–º–µ–Ω—è—é—Ç—Å—è**
- Negative batches **–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è** –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞

### 3.3. –†–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏

**–§–∞–π–ª:** `src/stores/sales/composables/useProfitCalculation.ts`

```typescript
const profit = {
  revenue: item.finalPrice, // 100,000 IDR
  cost: actualCost.totalCost, // 2,000 IDR (from FIFO)
  profit: revenue - cost, // 98,000 IDR
  profitMargin: ((revenue - cost) / revenue) * 100 // 98%
}
```

### 3.4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```typescript
const transaction = {
  id: generateShortId('st-'),
  orderId: order.id,
  timestamp: now,
  revenue: totalRevenue,
  cost: totalCost,
  profit: totalRevenue - totalCost,
  items: items.map(item => ({
    menuItemId: item.menuItemId,
    name: item.name,
    quantity: item.quantity,
    price: item.price,
    cost: item.actualCost
  })),
  paymentMethods: ['cash'],
  shiftId: currentShift.id
}

// Save to Supabase
await supabase.from('sales_transactions').insert(transaction)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –≠—Ç–∞–ø–∞ 3:**

- ‚úÖ Transaction —Å–æ–∑–¥–∞–Ω–∞ –≤ `sales_transactions` table
- ‚úÖ COGS —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –∏–∑ FIFO batches
- ‚úÖ Profit calculated
- ‚è≠Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≠—Ç–∞–ø—É 4 (Write-Off)

---

## –≠—Ç–∞–ø 4: –°–ø–∏—Å–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤

### –§–∞–π–ª—ã:

- `src/stores/sales/recipeWriteOff/recipeWriteOffStore.ts`
- `src/stores/sales/recipeWriteOff/composables/useDecomposition.ts`
- `src/stores/storage/storageService.ts`
- `src/stores/preparation/negativeBatchService.ts`

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

### 4.1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Write-Off

```typescript
recipeWriteOffStore.processItemWriteOff({
  menuItemName: item.name,
  menuItemId: item.menuItemId,
  variantId: item.variantId,
  quantity: item.quantity,
  salesTransactionId: transaction.id
})
```

### 4.2. –î–ï–ö–û–ú–ü–û–ó–ò–¶–ò–Ø –º–µ–Ω—é ‚Üí –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã

**–§–∞–π–ª:** `src/stores/sales/recipeWriteOff/composables/useDecomposition.ts`

**–¶–µ–ª—å:** –†–∞—Å–∫—Ä—ã—Ç—å menu item –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (products/preparations)

```typescript
const { decomposeMenuItem } = useDecomposition()

const result = decomposeMenuItem(
  menuItemId: '1880d1c2-...',
  variantId: 'f2c05dbe-...',
  soldQuantity: 1
)

// –ü—Ä–∏–º–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞:
// variant.composition = [
//   { type: 'preparation', id: 'ba109...', quantity: 20, unit: 'gram' }
// ]
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏:**

```typescript
function decomposeComponent(component, multiplier) {
  if (component.type === 'product') {
    // ‚úÖ Product - –∫–æ–Ω–µ—á–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º
    return [
      {
        type: 'product',
        id: component.id,
        quantity: component.quantity * multiplier,
        unit: component.unit
      }
    ]
  }

  if (component.type === 'preparation') {
    // –ü–æ–ª—É—á–∞–µ–º preparation –∏–∑ recipesStore
    const preparation = recipesStore.activePreparations.find(p => p.id === component.id)

    if (!preparation) {
      console.error('Preparation not found:', component.id)
      return []
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ —É preparation sub-components?
    if (preparation.composition && preparation.composition.length > 0) {
      // ‚úÖ Preparation —Å sub-components - –†–ê–°–ö–†–´–í–ê–ï–ú —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ
      const subItems = []
      for (const subComponent of preparation.composition) {
        const decomposed = decomposeComponent(
          subComponent,
          multiplier * (component.quantity / preparation.outputQuantity)
        )
        subItems.push(...decomposed)
      }
      return subItems
    } else {
      // ‚úÖ Preparation –ë–ï–ó sub-components - –ù–ï —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º!
      // –°–ø–∏—Å—ã–≤–∞–µ–º –∫–∞–∫ preparation batch —Ü–µ–ª–∏–∫–æ–º
      return [
        {
          type: 'preparation',
          id: component.id,
          quantity: component.quantity * multiplier,
          unit: component.unit,
          note: 'Cost will be calculated from FIFO batches'
        }
      ]
    }
  }
}
```

**–ü—Ä–∏–º–µ—Ä –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏:**

**–°–ª—É—á–∞–π 1: Preparation –ë–ï–ó sub-components (Dragon test)**

```typescript
// Input:
variant.composition = [{ type: 'preparation', id: 'ba109...', quantity: 20, unit: 'gram' }]

// Output:
decomposedItems = [{ type: 'preparation', id: 'ba109...', quantity: 20, unit: 'gram' }]
// ‚Üê –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è! –°–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ preparation batch
```

**–°–ª—É—á–∞–π 2: Preparation –° sub-components (–Ω–∞–ø—Ä–∏–º–µ—Ä "–°–æ—É—Å")**

```typescript
// Input:
variant.composition = [{ type: 'preparation', id: 'sauce-123', quantity: 50, unit: 'ml' }]

// Sauce preparation:
sauce.composition = [
  { type: 'product', id: 'tomato', quantity: 30, unit: 'gram' },
  { type: 'product', id: 'sugar', quantity: 5, unit: 'gram' }
]

// Output (–ø–æ—Å–ª–µ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–π –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏):
decomposedItems = [
  { type: 'product', id: 'tomato', quantity: 30, unit: 'gram' },
  { type: 'product', id: 'sugar', quantity: 5, unit: 'gram' }
]
// ‚Üê –†–∞—Å–∫—Ä—ã—Ç–æ –¥–æ products!
```

**Merge duplicates:**

```typescript
// –ï—Å–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π product/preparation –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑:
mergeDuplicateItems(decomposedItems)[
  // –î–æ merge:
  ({ type: 'product', id: 'tomato', quantity: 30 }, { type: 'product', id: 'tomato', quantity: 10 })
][
  // –ü–æ—Å–ª–µ merge:
  { type: 'product', id: 'tomato', quantity: 40 }
]
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏:**

```typescript
{
  success: true,
  data: {
    items: [
      { type: 'preparation', id: 'ba109...', quantity: 20, unit: 'gram' }
    ],
    totalItems: 1,
    totalCost: 0  // ‚Üê –ë—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –ø—Ä–∏ write-off
  }
}
```

### 4.3. –°–æ–∑–¥–∞–Ω–∏–µ Write-Off –æ–ø–µ—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `src/stores/storage/storageService.ts`

```typescript
storageService.createWriteOff({
  department: 'kitchen',
  reason: 'sale', // Affects KPI!
  items: decomposedItems,
  notes: `Sale transaction: ${salesTransactionId}`,
  userId: currentUser.id,
  shiftId: currentShift.id
})
```

**–î–ª—è –∫–∞–∂–¥–æ–≥–æ item:**

#### –î–ª—è PRODUCT:

```typescript
allocateProductFIFO(productId, quantity, department) {
  // 1. Get active batches
  const batches = storageStore.batches
    .filter(b =>
      b.productId === productId &&
      b.department === department &&
      b.status === 'active' &&
      b.currentQuantity > 0
    )
    .sort(by productionDate)  // FIFO

  // 2. Allocate
  const allocations = []
  let remaining = quantity

  for (const batch of batches) {
    const allocated = Math.min(remaining, batch.currentQuantity)

    // Update batch
    batch.currentQuantity -= allocated
    if (batch.currentQuantity === 0) {
      batch.status = 'depleted'
    }

    allocations.push({ batchId: batch.id, quantity: allocated })
    remaining -= allocated
  }

  // 3. IF shortage ‚Üí create negative batch
  if (remaining > 0) {
    const cost = await calculateNegativeBatchCost(productId, remaining)
    const negativeBatch = await negativeBatchService.createNegativeBatch({
      productId,
      department,
      quantity: -remaining,  // Negative!
      cost
    })

    allocations.push({
      batchId: negativeBatch.id,
      quantity: remaining,
      isNegative: true
    })
  }

  return allocations
}
```

#### –î–ª—è PREPARATION:

```typescript
allocatePreparationFIFO(preparationId, quantity, department) {
  // 1. Get active batches (including negative!)
  const batches = preparationStore.batches
    .filter(b =>
      b.preparationId === preparationId &&
      b.department === department &&
      b.isActive &&
      b.currentQuantity !== 0  // ‚Üê Including negative!
    )
    .sort(by productionDate)  // FIFO

  // 2. Allocate
  const allocations = []
  let remaining = quantity

  for (const batch of batches) {
    const allocated = Math.min(remaining, Math.abs(batch.currentQuantity))

    // Update batch
    if (batch.currentQuantity > 0) {
      // Positive batch
      batch.currentQuantity -= allocated
      if (batch.currentQuantity === 0) {
        batch.status = 'depleted'
      }
    } else {
      // Negative batch - —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –µ—â–µ –±–æ–ª–µ–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º
      batch.currentQuantity -= allocated
    }

    allocations.push({ batchId: batch.id, quantity: allocated })
    remaining -= allocated
  }

  // 3. IF shortage ‚Üí create/update negative batch
  if (remaining > 0) {
    // Check: –µ—Å—Ç—å –ª–∏ —É–∂–µ negative batch?
    const existingNegative = await negativeBatchService.getActiveNegativeBatch(
      preparationId,
      department
    )

    if (existingNegative) {
      // ‚úÖ UPDATE existing negative batch
      const cost = existingNegative.costPerUnit

      await negativeBatchService.updateNegativeBatch(
        existingNegative.id,
        remaining,  // Additional shortage
        cost
      )

      allocations.push({
        batchId: existingNegative.id,
        quantity: remaining,
        isNegative: true
      })
    } else {
      // ‚úÖ CREATE new negative batch

      // Calculate cost using fallback chain
      const cost = await negativeBatchService.calculateNegativeBatchCost(
        preparationId,
        remaining
      )

      const negativeBatch = await negativeBatchService.createNegativeBatch({
        preparationId,
        department,
        quantity: -remaining,  // Negative!
        unit: preparation.outputUnit,
        cost,
        reason: 'sale',
        sourceOperationType: 'pos_order'
      })

      allocations.push({
        batchId: negativeBatch.id,
        quantity: remaining,
        isNegative: true
      })
    }
  }

  return allocations
}
```

### 4.4. –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–ª—è Negative Batch

**–§—É–Ω–∫—Ü–∏—è:** `calculateNegativeBatchCost()`

**–§–∞–π–ª—ã:**

- `src/stores/preparation/negativeBatchService.ts:53-129` (preparations)
- `src/stores/storage/negativeBatchService.ts:55-132` (products)

**–£–ª—É—á—à–µ–Ω–Ω—ã–π Fallback Chain (4 —É—Ä–æ–≤–Ω—è):**

```
1. Last active batch cost          ‚Üê getLastActiveBatch() ‚Üí batch.costPerUnit
   ‚Üì FAIL
2. Depleted batches average (5—à—Ç)  ‚Üê SELECT FROM *_batches WHERE status='depleted' ORDER BY date DESC LIMIT 5
   ‚Üì FAIL
3. last_known_cost from DB         ‚Üê SELECT last_known_cost FROM products/preparations
   ‚Üì FAIL
4. 0 + CRITICAL ERROR               ‚Üê console.error() + errorContext { failedFallbacks, suggestedAction }
```

#### 4.4.1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `last_known_cost`

**Trigger:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ batch –≤ `createReceipt()`

**–§–∞–π–ª—ã:**

- `src/stores/storage/storageService.ts:774-793` (products)
- `src/stores/preparation/preparationService.ts:814-831` (preparations)

**Flow:**

```
createReceipt()
  ‚Üí INSERT batch INTO *_batches (cost_per_unit = X)
  ‚Üí UPDATE products/preparations SET last_known_cost = X WHERE id = item_id
  ‚Üí log: "‚úÖ Updated last_known_cost"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

- ‚úÖ `last_known_cost` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º receipt
- ‚úÖ Fallback level 3 –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª–µ–Ω
- ‚ùå Cost = 0 ‚Üí CRITICAL ERROR (–Ω–µ –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º)

### 4.5. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –≤ –ë–î

**–¢–∞–±–ª–∏—Ü—ã:**

```
1. write_off_operations  ‚Üê operation metadata (document_number, reason, affects_kpi)
2. batch_operations      ‚Üê links batches to operation (batch_id, operation_id, quantity)
3. *_batches             ‚Üê update current_quantity, status
```

**–§–∞–π–ª:** `src/stores/storage/storageService.ts:844-1170`

### 4.6. –ó–∞–ø–∏—Å—å —Ä–∞—Å—Ö–æ–¥–∞ –≤ Account Store

**–£—Å–ª–æ–≤–∏–µ:** `reason` affects KPI (sale, damage, spoilage)

**Flow:**

```
IF affects_kpi:
  accountStore.createTransaction({
    type: 'expense',
    amount: -totalCost,
    category: 'inventory_adjustment'
  })
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –≠—Ç–∞–ø–∞ 4:**

- ‚úÖ Write-off operation —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ Batches –æ–±–Ω–æ–≤–ª–µ–Ω—ã (FIFO)
- ‚úÖ Negative batches —Å–æ–∑–¥–∞–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏ shortage
- ‚úÖ Expense –∑–∞–ø–∏—Å–∞–Ω –≤ Account Store (–µ—Å–ª–∏ affects_kpi)
- ‚úÖ Inventory –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É Step 3.2 –∏ Step 4.2

| –ê—Å–ø–µ–∫—Ç                          | Step 3.2 (Sales COGS)              | Step 4.2 (Write-Off)            |
| ------------------------------- | ---------------------------------- | ------------------------------- |
| **–¶–µ–ª—å**                        | –ü–æ—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è profit | –°–ø–∏—Å–∞—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã |
| **–§–∞–π–ª**                        | `useActualCostCalculation.ts`      | `useDecomposition.ts`           |
| **–î–µ–π—Å—Ç–≤–∏–µ**                    | –ß–∏—Ç–∞–µ—Ç batches (read-only)         | –ò–∑–º–µ–Ω—è–µ—Ç batches (write)        |
| **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç negative batches** | ‚úÖ –î–∞ (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏)      | ‚úÖ –î–∞ (—Å–æ–∑–¥–∞–µ—Ç –ø—Ä–∏ shortage)    |
| **–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è**                | –ù–µ—Ç (–±–µ—Ä–µ—Ç variant.composition)    | ‚úÖ –î–∞ (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è)             |
| **–û–±–Ω–æ–≤–ª—è–µ—Ç –ë–î**                | ‚ùå –ù–µ—Ç                             | ‚úÖ –î–∞                           |

### Negative Batches

**–ß—Ç–æ —ç—Ç–æ:**

- Batch —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º `currentQuantity`
- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç "–¥–æ–ª–≥" –ø–µ—Ä–µ–¥ —Å–∫–ª–∞–¥–æ–º
- –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ —Å–ø–∏—Å—ã–≤–∞–µ–º –±–æ–ª—å—à–µ —á–µ–º –µ—Å—Ç—å

**–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è:**

- –ü—Ä–∏ write-off —Å shortage
- –ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –±–µ–∑ stock

**Reconciliation:**

- –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π receipt ‚Üí negative batch reconciled
- Status: `active` ‚Üí `depleted`
- `reconciled_at` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è

**–ü—Ä–∏–º–µ—Ä:**

```typescript
// –î–æ –ø—Ä–æ–¥–∞–∂–∏:
batches = [] // –ù–µ—Ç batches –¥–ª—è Dragon test

// –ü–æ—Å–ª–µ 1-–π –ø—Ä–æ–¥–∞–∂–∏ (20 gram):
batches = [
  {
    batchNumber: 'NEG-PREP-1764858333956',
    currentQuantity: -20,
    costPerUnit: 100000,
    totalValue: -2000000,
    isNegative: true
  }
]

// –ü–æ—Å–ª–µ 2-–π –ø—Ä–æ–¥–∞–∂–∏ (20 gram):
batches = [
  {
    batchNumber: 'NEG-PREP-1764858333956',
    currentQuantity: -40, // ‚Üê –û–±–Ω–æ–≤–∏–ª—Å—è!
    costPerUnit: 100000,
    totalValue: -4000000,
    isNegative: true
  }
]

// –ü–æ—Å–ª–µ receipt (–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ 100 gram):
batches = [
  {
    batchNumber: 'NEG-PREP-1764858333956',
    currentQuantity: -40,
    status: 'depleted',
    reconciledAt: '2024-12-04T15:30:00Z' // ‚Üê Reconciled!
  },
  {
    batchNumber: 'PREP-1764858500000',
    currentQuantity: 60, // ‚Üê –û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ reconciliation (100 - 40)
    costPerUnit: 95000, // ‚Üê –ù–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ receipt
    isNegative: false
  }
]
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∞ –≤ Payment (Step 2)

```typescript
try {
  await paymentsStore.processSimplePayment(...)
} catch (error) {
  // Rollback: order status ‚Üí 'pending'
  // Show error to user
  // Payment –ù–ï —Å–æ–∑–¥–∞–Ω
  // Sales transaction –ù–ï —Å–æ–∑–¥–∞–Ω–∞
  // Write-off –ù–ï –≤—ã–ø–æ–ª–Ω–µ–Ω
}
```

### –û—à–∏–±–∫–∞ –≤ Sales Recording (Step 3)

```typescript
try {
  await salesStore.recordSalesTransaction(...)
} catch (error) {
  // Payment –£–ñ–ï —Å–æ–∑–¥–∞–Ω!
  // Order status = 'paid'
  // –ù–æ sales transaction –ù–ï —Å–æ–∑–¥–∞–Ω–∞

  // ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: Manual reconciliation required!
  // –õ–æ–≥ –æ—à–∏–±–∫–∏ ‚Üí errors.md
  // Admin –¥–æ–ª–∂–µ–Ω –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞—Ç—å sales transaction
}
```

### –û—à–∏–±–∫–∞ –≤ Write-Off (Step 4)

```typescript
try {
  await recipeWriteOffStore.processItemWriteOff(...)
} catch (error) {
  // Payment —Å–æ–∑–¥–∞–Ω ‚úÖ
  // Sales transaction —Å–æ–∑–¥–∞–Ω–∞ ‚úÖ
  // –ù–æ write-off –ù–ï –≤—ã–ø–æ–ª–Ω–µ–Ω ‚ùå

  // –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:
  // - Inventory –ù–ï –æ–±–Ω–æ–≤–ª–µ–Ω
  // - Batches –ù–ï —Å–ø–∏—Å–∞–Ω—ã
  // - Account expense –ù–ï –∑–∞–ø–∏—Å–∞–Ω

  // –†–µ—à–µ–Ω–∏–µ:
  // 1. Retry –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (3 –ø–æ–ø—ã—Ç–∫–∏)
  // 2. –ï—Å–ª–∏ fail ‚Üí queue for manual write-off
  // 3. Admin –≤–∏–¥–∏—Ç pending write-offs –≤ UI
}
```

### –û—à–∏–±–∫–∞ –≤ Negative Batch Cost Calculation (Step 4.4)

```typescript
try {
  const cost = await calculateNegativeBatchCost(preparationId, quantity)
} catch (error) {
  // –í—Å–µ fallback —à–∞–≥–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º estimated cost: 100 IDR

  console.error(`‚ùå CRITICAL: NO COST DATA FOUND`)

  // ‚ö†Ô∏è WARNING: Inaccurate COGS!
  // Admin –¥–æ–ª–∂–µ–Ω:
  // 1. –°–æ–∑–¥–∞—Ç—å receipt operation –¥–ª—è preparation
  // 2. –û–±–Ω–æ–≤–∏—Ç—å negative batch cost –≤—Ä—É—á–Ω—É—é
}
```

---

## –õ–æ–≥–∏ –∏ Debugging

### –ö–ª—é—á–µ–≤—ã–µ –ª–æ–≥–∏:

```typescript
// Step 1: Order creation
console.log('[OrdersStore] Order created:', orderId)

// Step 2: Payment
console.log('[PaymentsStore] Payment processed:', paymentId)

// Step 3: Sales Recording
console.log('[SalesStore] Transaction saved:', transactionId)
console.log('[ActualCostCalculation] Actual cost calculated:', { totalCost })

// Step 4: Write-Off
console.log('[RecipeWriteOffStore] Processing write-off for item:', item)
console.log('[DecompositionEngine] Decomposition complete:', { totalProducts })
console.log('[StorageService] Creating write-off operation:', { documentNumber })
console.log('[StorageService] ‚ö†Ô∏è Shortage detected - checking for negative batch')
console.log('[NegativeBatchService] üîÑ Attempting dynamic cost calculation')
console.log('[NegativeBatchService] ‚úÖ Calculated theoretical cost:', cost)
console.log('[NegativeBatchService] ‚úÖ Created negative batch:', batchNumber)
```

### Debugging checklist:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å decomposition:**

   ```typescript
   const result = await decomposeMenuItem(menuItemId, variantId, 1)
   console.log('Decomposed items:', result.items)
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å batches:**

   ```typescript
   const batches = preparationStore.batches.filter(
     b => b.preparationId === preparationId && b.department === 'kitchen'
   )
   console.log('Available batches:', batches)
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å ingredients:**

   ```typescript
   const ingredients = await supabase
     .from('preparation_ingredients')
     .select('*')
     .eq('preparation_id', preparationId)
   console.log('Ingredients:', ingredients)
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å negative batches:**
   ```typescript
   const negativeBatches = await negativeBatchService.getNegativeBatches(preparationId)
   console.log('Negative batches:', negativeBatches)
   ```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–¥–∞–∂–∏ - —ç—Ç–æ —Å–ª–æ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∏–∑ 4 —ç—Ç–∞–ø–æ–≤:**

1. ‚úÖ **POS Order** - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
2. ‚úÖ **Payment** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
3. ‚úÖ **Sales Recording** - —É—á–µ—Ç –ø—Ä–æ–¥–∞–∂ + COGS calculation
4. ‚úÖ **Write-Off** - —Å–ø–∏—Å–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å–æ —Å–∫–ª–∞–¥–∞

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- **–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ Step 4 (–Ω–µ –≤ Step 3)
- **COGS** —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ FIFO batches (–≤–∫–ª—é—á–∞—è negative)
- **Negative batches** —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ shortage
- **Fallback chain** –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (6 —É—Ä–æ–≤–Ω–µ–π)
- **Reconciliation** negative batches –ø—Ä–∏ receipt

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**

- –û–±—â–µ–µ –≤—Ä–µ–º—è: ~6-11 —Å–µ–∫—É–Ω–¥
- –ö—Ä–∏—Ç–∏—á–Ω–æ: Payment –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±—ã—Å—Ç—Ä—ã–º (<2 —Å–µ–∫)
- Write-Off –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–≤ —Ñ–æ–Ω–µ)

**–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**

- Rollback –¥–ª—è Payment errors
- Retry mechanism –¥–ª—è Write-Off errors
- Manual reconciliation –¥–ª—è critical failures
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
