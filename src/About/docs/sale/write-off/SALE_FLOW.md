# Sale Flow Documentation - ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ Ğ¸ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ

## ğŸ“‹ ĞĞ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ

1. [ĞĞ±Ğ·Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°](#Ğ¾Ğ±Ğ·Ğ¾Ñ€-Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°)
2. [Ğ­Ñ‚Ğ°Ğ¿ 1: ĞÑ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ° (POS)](#ÑÑ‚Ğ°Ğ¿-1-Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ-Ğ·Ğ°ĞºĞ°Ğ·Ğ°-pos)
3. [Ğ­Ñ‚Ğ°Ğ¿ 2: ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°](#ÑÑ‚Ğ°Ğ¿-2-Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°-Ğ·Ğ°ĞºĞ°Ğ·Ğ°)
4. [Ğ­Ñ‚Ğ°Ğ¿ 3: Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸](#ÑÑ‚Ğ°Ğ¿-3-Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ-Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸-Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸)
5. [Ğ­Ñ‚Ğ°Ğ¿ 4: Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¸Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²](#ÑÑ‚Ğ°Ğ¿-4-ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ-Ğ¸Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²)
6. [Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸](#Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ-Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸)
7. [ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº](#Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°-Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº)

---

## ĞĞ±Ğ·Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°

**ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ ÑĞ¾ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ¸Ğ· 4 ÑÑ‚Ğ°Ğ¿Ğ¾Ğ²:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   POS        â”‚â”€â”€â”€â”€â–¶â”‚   Payment    â”‚â”€â”€â”€â”€â–¶â”‚    Sales     â”‚â”€â”€â”€â”€â–¶â”‚  Write-Off   â”‚
â”‚   Order      â”‚     â”‚   Processing â”‚     â”‚  Recording   â”‚     â”‚   Inventory  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ           ĞĞ¿Ğ»Ğ°Ñ‚Ğ°              Ğ£Ñ‡ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶         Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑĞ¾ ÑĞºĞ»Ğ°Ğ´Ğ°
  Ğ·Ğ°ĞºĞ°Ğ·Ğ°             ÑÑ€ĞµĞ´ÑÑ‚Ğ²Ğ°Ğ¼Ğ¸          + ÑĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ      FIFO + negative
```

**Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ»Ğ¸Ğ½Ğ¸Ñ:**

- **POS Order**: ĞœĞ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾ (ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ°)
- **Payment**: 1-2 ÑĞµĞº (Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°)
- **Sales Recording**: 2-3 ÑĞµĞº (Ñ€Ğ°ÑÑ‡ĞµÑ‚ COGS + Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ‘Ğ”)
- **Write-Off**: 3-5 ÑĞµĞº (Ğ´ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ + FIFO allocation + negative batches)

**ĞĞ±Ñ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ:** ~6-11 ÑĞµĞºÑƒĞ½Ğ´

---

## Ğ­Ñ‚Ğ°Ğ¿ 1: ĞÑ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ° (POS)

### Ğ¤Ğ°Ğ¹Ğ»Ñ‹:

- `src/stores/pos/orders/ordersStore.ts`
- `src/stores/pos/tables/tablesStore.ts`
- `src/views/pos/order/OrderSection.vue`

### Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚:

1. **ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ ÑÑ‚Ğ¾Ğ»/Ñ‚Ğ¸Ğ¿ Ğ·Ğ°ĞºĞ°Ğ·Ğ°**

   - Ğ¢Ğ¸Ğ¿: `dine-in`, `takeaway`, `delivery`
   - Ğ”Ğ»Ñ `dine-in` Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ÑÑ ÑÑ‚Ğ¾Ğ» Ğ¸Ğ· `tablesStore`

2. **Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ¼ĞµĞ½Ñ**

   ```typescript
   order.items.push({
     menuItemId: '1880d1c2-...',
     variantId: 'f2c05dbe-...',
     name: 'Test',
     variantName: 'Dragon',
     quantity: 1,
     price: 100000,
     discounts: []
   })
   ```

3. **Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°ĞºĞ°Ğ· Ğ² ordersStore**
   ```typescript
   ordersStore.createOrder({
     tableId?: string,
     orderType: 'dine-in' | 'takeaway' | 'delivery',
     items: OrderItem[],
     status: 'pending'
   })
   ```

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:**

- Order ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ñ `status: 'pending'`
- Order ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½ Ğ² localStorage (offline-first)
- UI Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½

---

## Ğ­Ñ‚Ğ°Ğ¿ 2: ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°

### Ğ¤Ğ°Ğ¹Ğ»Ñ‹:

- `src/stores/pos/payments/paymentsStore.ts`
- `src/views/pos/order/dialogs/PaymentDialog.vue`

### Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚:

1. **ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "Pay"**

   - ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ `PaymentDialog`
   - Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹: `cash`, `card`, `qr`

2. **ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°**

   ```typescript
   // Simple payment (Ğ¾Ğ´Ğ¸Ğ½ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹)
   paymentsStore.processSimplePayment({
     orderId: order.id,
     amount: order.totalAmount,
     paymentMethod: 'cash',
     tendered: 150000
   })

   // Multiple payments (Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ²)
   paymentsStore.processMultiplePayments({
     orderId: order.id,
     payments: [
       { method: 'cash', amount: 50000 },
       { method: 'card', amount: 50000 }
     ]
   })
   ```

3. **ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°**
   - Order status: `pending` â†’ `paid`
   - Payment record ÑĞ¾Ğ·Ğ´Ğ°Ğ½
   - Ğ•ÑĞ»Ğ¸ `dine-in`: Table status: `occupied` â†’ `available`

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:**

- Payment ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½ Ğ² Ğ‘Ğ” (`payments` table)
- Order Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ (`orders` table)
- Ğ¡Ğ´Ğ°Ñ‡Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ° (Ğ´Ğ»Ñ cash)

---

## Ğ­Ñ‚Ğ°Ğ¿ 3: Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸

### Ğ¤Ğ°Ğ¹Ğ»Ñ‹:

- `src/stores/sales/salesStore.ts`
- `src/stores/sales/composables/useActualCostCalculation.ts`
- `src/stores/sales/composables/useProfitCalculation.ts`

### Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚:

### 3.1. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

```typescript
salesStore.recordSalesTransaction({
  orderId: order.id,
  items: order.items,
  totalRevenue: order.totalAmount,
  paymentMethods: ['cash'],
  shiftId: currentShift.id
})
```

### 3.2. Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¤ĞĞšĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ™ ÑĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (FIFO)

**Ğ¤Ğ°Ğ¹Ğ»:** `src/stores/sales/composables/useActualCostCalculation.ts`

```typescript
const { calculateActualCost } = useActualCostCalculation()

for (const item of orderItems) {
  // Get menu item variant
  const variant = menuStore.getVariant(item.menuItemId, item.variantId)

  // variant.composition = [
  //   { type: 'preparation', id: 'ba109...', quantity: 20, unit: 'gram' },
  //   { type: 'product', id: '5212...', quantity: 5, unit: 'piece' }
  // ]

  let itemCost = 0

  for (const component of variant.composition) {
    if (component.type === 'product') {
      // Allocate from product batches (FIFO)
      const result = allocateFromProductBatches(component.id, component.quantity, department)
      itemCost += result.totalCost
    }

    if (component.type === 'preparation') {
      // Allocate from preparation batches (FIFO)
      const result = allocateFromPreparationBatches(component.id, component.quantity, department)
      itemCost += result.totalCost
    }
  }

  totalCost += itemCost
}
```

**ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ FIFO allocation:**

```typescript
// preparationStore.allocateBatches()
function allocateFromPreparationBatches(preparationId, quantity, department) {
  // 1. Get active batches (INCLUDING negative batches!)
  const batches = preparationStore.batches
    .filter(
      b =>
        b.preparationId === preparationId &&
        b.department === department &&
        b.isActive &&
        b.currentQuantity !== 0 // â† Ğ’ĞºĞ»ÑÑ‡Ğ°Ñ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ!
    )
    .sort((a, b) => new Date(a.productionDate).getTime() - new Date(b.productionDate).getTime())

  // 2. Allocate FIFO
  let remaining = quantity
  let totalCost = 0
  const allocations = []

  for (const batch of batches) {
    if (remaining <= 0) break

    const allocated = Math.min(remaining, batch.currentQuantity)
    totalCost += allocated * batch.costPerUnit

    allocations.push({
      batchId: batch.id,
      quantity: allocated,
      cost: batch.costPerUnit
    })

    remaining -= allocated
  }

  return { totalCost, allocations, deficit: remaining }
}
```

**âš ï¸ Ğ’ĞĞ–ĞĞ:** ĞĞ° ÑÑ‚Ğ¾Ğ¼ ÑÑ‚Ğ°Ğ¿Ğµ **ĞĞ• Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ write-off**!

- Ğ­Ñ‚Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ **Ñ€Ğ°ÑÑ‡ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸** Ğ´Ğ»Ñ profit calculation
- Batches **Ñ‡Ğ¸Ñ‚Ğ°ÑÑ‚ÑÑ**, Ğ½Ğ¾ **Ğ½Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ÑÑÑ‚ÑÑ**
- Negative batches **Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ** Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ°

### 3.3. Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»Ğ¸

**Ğ¤Ğ°Ğ¹Ğ»:** `src/stores/sales/composables/useProfitCalculation.ts`

```typescript
const profit = {
  revenue: item.finalPrice, // 100,000 IDR
  cost: actualCost.totalCost, // 2,000 IDR (from FIFO)
  profit: revenue - cost, // 98,000 IDR
  profitMargin: ((revenue - cost) / revenue) * 100 // 98%
}
```

### 3.4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸

```typescript
const transaction = {
  id: generateShortId('st-'),
  orderId: order.id,
  timestamp: now,
  revenue: totalRevenue,
  cost: totalCost,
  profit: totalRevenue - totalCost,
  items: items.map(item => ({
    menuItemId: item.menuItemId,
    name: item.name,
    quantity: item.quantity,
    price: item.price,
    cost: item.actualCost
  })),
  paymentMethods: ['cash'],
  shiftId: currentShift.id
}

// Save to Supabase
await supabase.from('sales_transactions').insert(transaction)
```

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ­Ñ‚Ğ°Ğ¿Ğ° 3:**

- âœ… Transaction ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ² `sales_transactions` table
- âœ… COGS Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ° Ğ¸Ğ· FIFO batches
- âœ… Profit calculated
- â­ï¸ ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğº Ğ­Ñ‚Ğ°Ğ¿Ñƒ 4 (Write-Off)

---

## Ğ­Ñ‚Ğ°Ğ¿ 4: Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¸Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²

### Ğ¤Ğ°Ğ¹Ğ»Ñ‹:

- `src/stores/sales/recipeWriteOff/recipeWriteOffStore.ts`
- `src/stores/sales/recipeWriteOff/composables/useDecomposition.ts`
- `src/stores/storage/storageService.ts`
- `src/stores/preparation/negativeBatchService.ts`

### Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚:

### 4.1. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Write-Off

```typescript
recipeWriteOffStore.processItemWriteOff({
  menuItemName: item.name,
  menuItemId: item.menuItemId,
  variantId: item.variantId,
  quantity: item.quantity,
  salesTransactionId: transaction.id
})
```

### 4.2. Ğ”Ğ•ĞšĞĞœĞŸĞĞ—Ğ˜Ğ¦Ğ˜Ğ¯ Ğ¼ĞµĞ½Ñ â†’ Ğ¸Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ñ‹

**Ğ¤Ğ°Ğ¹Ğ»:** `src/stores/sales/recipeWriteOff/composables/useDecomposition.ts`

**Ğ¦ĞµĞ»ÑŒ:** Ğ Ğ°ÑĞºÑ€Ñ‹Ñ‚ÑŒ menu item Ğ´Ğ¾ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¸Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² (products/preparations)

```typescript
const { decomposeMenuItem } = useDecomposition()

const result = decomposeMenuItem(
  menuItemId: '1880d1c2-...',
  variantId: 'f2c05dbe-...',
  soldQuantity: 1
)

// ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ°:
// variant.composition = [
//   { type: 'preparation', id: 'ba109...', quantity: 20, unit: 'gram' }
// ]
```

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ´ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸:**

```typescript
function decomposeComponent(component, multiplier) {
  if (component.type === 'product') {
    // âœ… Product - ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚, Ğ½Ğµ Ñ€Ğ°ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼
    return [
      {
        type: 'product',
        id: component.id,
        quantity: component.quantity * multiplier,
        unit: component.unit
      }
    ]
  }

  if (component.type === 'preparation') {
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ preparation Ğ¸Ğ· recipesStore
    const preparation = recipesStore.activePreparations.find(p => p.id === component.id)

    if (!preparation) {
      console.error('Preparation not found:', component.id)
      return []
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼: ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ñƒ preparation sub-components?
    if (preparation.composition && preparation.composition.length > 0) {
      // âœ… Preparation Ñ sub-components - Ğ ĞĞ¡ĞšĞ Ğ«Ğ’ĞĞ•Ğœ Ñ€ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ¾
      const subItems = []
      for (const subComponent of preparation.composition) {
        const decomposed = decomposeComponent(
          subComponent,
          multiplier * (component.quantity / preparation.outputQuantity)
        )
        subItems.push(...decomposed)
      }
      return subItems
    } else {
      // âœ… Preparation Ğ‘Ğ•Ğ— sub-components - ĞĞ• Ñ€Ğ°ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼!
      // Ğ¡Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ğº preparation batch Ñ†ĞµĞ»Ğ¸ĞºĞ¾Ğ¼
      return [
        {
          type: 'preparation',
          id: component.id,
          quantity: component.quantity * multiplier,
          unit: component.unit,
          note: 'Cost will be calculated from FIFO batches'
        }
      ]
    }
  }
}
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ´ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸:**

**Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹ 1: Preparation Ğ‘Ğ•Ğ— sub-components (Dragon test)**

```typescript
// Input:
variant.composition = [{ type: 'preparation', id: 'ba109...', quantity: 20, unit: 'gram' }]

// Output:
decomposedItems = [{ type: 'preparation', id: 'ba109...', quantity: 20, unit: 'gram' }]
// â† ĞĞµ Ñ€Ğ°ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ! Ğ¡Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº preparation batch
```

**Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹ 2: Preparation Ğ¡ sub-components (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ "Ğ¡Ğ¾ÑƒÑ")**

```typescript
// Input:
variant.composition = [{ type: 'preparation', id: 'sauce-123', quantity: 50, unit: 'ml' }]

// Sauce preparation:
sauce.composition = [
  { type: 'product', id: 'tomato', quantity: 30, unit: 'gram' },
  { type: 'product', id: 'sugar', quantity: 5, unit: 'gram' }
]

// Output (Ğ¿Ğ¾ÑĞ»Ğµ Ñ€ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ´ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸):
decomposedItems = [
  { type: 'product', id: 'tomato', quantity: 30, unit: 'gram' },
  { type: 'product', id: 'sugar', quantity: 5, unit: 'gram' }
]
// â† Ğ Ğ°ÑĞºÑ€Ñ‹Ñ‚Ğ¾ Ğ´Ğ¾ products!
```

**Merge duplicates:**

```typescript
// Ğ•ÑĞ»Ğ¸ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğ¹ product/preparation Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ°ĞµÑ‚ÑÑ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ·:
mergeDuplicateItems(decomposedItems)[
  // Ğ”Ğ¾ merge:
  ({ type: 'product', id: 'tomato', quantity: 30 }, { type: 'product', id: 'tomato', quantity: 10 })
][
  // ĞŸĞ¾ÑĞ»Ğµ merge:
  { type: 'product', id: 'tomato', quantity: 40 }
]
```

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ´ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸:**

```typescript
{
  success: true,
  data: {
    items: [
      { type: 'preparation', id: 'ba109...', quantity: 20, unit: 'gram' }
    ],
    totalItems: 1,
    totalCost: 0  // â† Ğ‘ÑƒĞ´ĞµÑ‚ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ° Ğ¿Ñ€Ğ¸ write-off
  }
}
```

### 4.3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Write-Off Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

**Ğ¤Ğ°Ğ¹Ğ»:** `src/stores/storage/storageService.ts`

```typescript
storageService.createWriteOff({
  department: 'kitchen',
  reason: 'sale', // Affects KPI!
  items: decomposedItems,
  notes: `Sale transaction: ${salesTransactionId}`,
  userId: currentUser.id,
  shiftId: currentShift.id
})
```

**Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ item:**

#### Ğ”Ğ»Ñ PRODUCT:

```typescript
allocateProductFIFO(productId, quantity, department) {
  // 1. Get active batches
  const batches = storageStore.batches
    .filter(b =>
      b.productId === productId &&
      b.department === department &&
      b.status === 'active' &&
      b.currentQuantity > 0
    )
    .sort(by productionDate)  // FIFO

  // 2. Allocate
  const allocations = []
  let remaining = quantity

  for (const batch of batches) {
    const allocated = Math.min(remaining, batch.currentQuantity)

    // Update batch
    batch.currentQuantity -= allocated
    if (batch.currentQuantity === 0) {
      batch.status = 'depleted'
    }

    allocations.push({ batchId: batch.id, quantity: allocated })
    remaining -= allocated
  }

  // 3. IF shortage â†’ create negative batch
  if (remaining > 0) {
    const cost = await calculateNegativeBatchCost(productId, remaining)
    const negativeBatch = await negativeBatchService.createNegativeBatch({
      productId,
      department,
      quantity: -remaining,  // Negative!
      cost
    })

    allocations.push({
      batchId: negativeBatch.id,
      quantity: remaining,
      isNegative: true
    })
  }

  return allocations
}
```

#### Ğ”Ğ»Ñ PREPARATION:

```typescript
allocatePreparationFIFO(preparationId, quantity, department) {
  // 1. Get active batches (including negative!)
  const batches = preparationStore.batches
    .filter(b =>
      b.preparationId === preparationId &&
      b.department === department &&
      b.isActive &&
      b.currentQuantity !== 0  // â† Including negative!
    )
    .sort(by productionDate)  // FIFO

  // 2. Allocate
  const allocations = []
  let remaining = quantity

  for (const batch of batches) {
    const allocated = Math.min(remaining, Math.abs(batch.currentQuantity))

    // Update batch
    if (batch.currentQuantity > 0) {
      // Positive batch
      batch.currentQuantity -= allocated
      if (batch.currentQuantity === 0) {
        batch.status = 'depleted'
      }
    } else {
      // Negative batch - ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ ĞµÑ‰Ğµ Ğ±Ğ¾Ğ»ĞµĞµ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼
      batch.currentQuantity -= allocated
    }

    allocations.push({ batchId: batch.id, quantity: allocated })
    remaining -= allocated
  }

  // 3. IF shortage â†’ create/update negative batch
  if (remaining > 0) {
    // Check: ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑƒĞ¶Ğµ negative batch?
    const existingNegative = await negativeBatchService.getActiveNegativeBatch(
      preparationId,
      department
    )

    if (existingNegative) {
      // âœ… UPDATE existing negative batch
      const cost = existingNegative.costPerUnit

      await negativeBatchService.updateNegativeBatch(
        existingNegative.id,
        remaining,  // Additional shortage
        cost
      )

      allocations.push({
        batchId: existingNegative.id,
        quantity: remaining,
        isNegative: true
      })
    } else {
      // âœ… CREATE new negative batch

      // Calculate cost using fallback chain
      const cost = await negativeBatchService.calculateNegativeBatchCost(
        preparationId,
        remaining
      )

      const negativeBatch = await negativeBatchService.createNegativeBatch({
        preparationId,
        department,
        quantity: -remaining,  // Negative!
        unit: preparation.outputUnit,
        cost,
        reason: 'sale',
        sourceOperationType: 'pos_order'
      })

      allocations.push({
        batchId: negativeBatch.id,
        quantity: remaining,
        isNegative: true
      })
    }
  }

  return allocations
}
```

### 4.4. Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Negative Batch

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ:** `calculateNegativeBatchCost()`

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**

- `src/stores/preparation/negativeBatchService.ts:53-129` (preparations)
- `src/stores/storage/negativeBatchService.ts:55-132` (products)

**Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ñ‹Ğ¹ Fallback Chain (5 ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹ Ğ´Ğ»Ñ products, 4 Ğ´Ğ»Ñ preparations):**

```
1. Last active batch cost          â† getLastActiveBatch() â†’ batch.costPerUnit
   â†“ FAIL
2. Depleted batches average (5ÑˆÑ‚)  â† SELECT FROM *_batches WHERE status='depleted' ORDER BY date DESC LIMIT 5
   â†“ FAIL
3. last_known_cost from DB         â† SELECT last_known_cost FROM products/preparations
   â†“ FAIL
4. base_cost_per_unit (products)   â† SELECT base_cost_per_unit FROM products (Ñ€ÑƒÑ‡Ğ½Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¸Ğ· ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°)
   â†“ FAIL (Ğ¸Ğ»Ğ¸ N/A Ğ´Ğ»Ñ preparations)
5. 0 + CRITICAL ERROR              â† console.error() + errorContext { failedFallbacks, suggestedAction }
```

> **Note:** `base_cost_per_unit` Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ products. Ğ”Ğ»Ñ preparations ÑÑ‚Ğ¾Ñ‚ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ.

#### 4.4.1. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ `last_known_cost`

**Trigger:** ĞŸÑ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ batch Ğ² `createReceipt()`

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**

- `src/stores/storage/storageService.ts:774-793` (products)
- `src/stores/preparation/preparationService.ts:814-831` (preparations)

**Flow:**

```
createReceipt()
  â†’ INSERT batch INTO *_batches (cost_per_unit = X)
  â†’ UPDATE products/preparations SET last_known_cost = X WHERE id = item_id
  â†’ log: "âœ… Updated last_known_cost"
```

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹:**

- âœ… `last_known_cost` Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ receipt
- âœ… Fallback level 3 Ğ²ÑĞµĞ³Ğ´Ğ° Ğ°ĞºÑ‚ÑƒĞ°Ğ»ĞµĞ½
- âŒ Cost = 0 â†’ CRITICAL ERROR (Ğ½Ğµ Ğ¼Ğ°ÑĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸ĞµĞ¼)

### 4.5. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ² Ğ‘Ğ”

**Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹:**

```
1. write_off_operations  â† operation metadata (document_number, reason, affects_kpi)
2. batch_operations      â† links batches to operation (batch_id, operation_id, quantity)
3. *_batches             â† update current_quantity, status
```

**Ğ¤Ğ°Ğ¹Ğ»:** `src/stores/storage/storageService.ts:844-1170`

### 4.6. Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ° Ğ² Account Store

**Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ:** `reason` affects KPI (sale, damage, spoilage)

**Flow:**

```
IF affects_kpi:
  accountStore.createTransaction({
    type: 'expense',
    amount: -totalCost,
    category: 'inventory_adjustment'
  })
```

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ­Ñ‚Ğ°Ğ¿Ğ° 4:**

- âœ… Write-off operation ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°
- âœ… Batches Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ (FIFO)
- âœ… Negative batches ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¸ shortage
- âœ… Expense Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½ Ğ² Account Store (ĞµÑĞ»Ğ¸ affects_kpi)
- âœ… Inventory Ğ°ĞºÑ‚ÑƒĞ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½

---

## Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸

### Ğ Ğ°Ğ·Ğ½Ğ¸Ñ†Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ Step 3.2 Ğ¸ Step 4.2

| ĞÑĞ¿ĞµĞºÑ‚                          | Step 3.2 (Sales COGS)              | Step 4.2 (Write-Off)            |
| ------------------------------- | ---------------------------------- | ------------------------------- |
| **Ğ¦ĞµĞ»ÑŒ**                        | ĞŸĞ¾ÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ÑĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ profit | Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¸Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ñ‹ |
| **Ğ¤Ğ°Ğ¹Ğ»**                        | `useActualCostCalculation.ts`      | `useDecomposition.ts`           |
| **Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ**                    | Ğ§Ğ¸Ñ‚Ğ°ĞµÑ‚ batches (read-only)         | Ğ˜Ğ·Ğ¼ĞµĞ½ÑĞµÑ‚ batches (write)        |
| **Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ negative batches** | âœ… Ğ”Ğ° (Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸)      | âœ… Ğ”Ğ° (ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¸ shortage)    |
| **Ğ”ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ**                | ĞĞµÑ‚ (Ğ±ĞµÑ€ĞµÑ‚ variant.composition)    | âœ… Ğ”Ğ° (Ñ€ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ°Ñ)             |
| **ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ‘Ğ”**                | âŒ ĞĞµÑ‚                             | âœ… Ğ”Ğ°                           |

### Negative Batches

**Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾:**

- Batch Ñ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ `currentQuantity`
- ĞŸÑ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ "Ğ´Ğ¾Ğ»Ğ³" Ğ¿ĞµÑ€ĞµĞ´ ÑĞºĞ»Ğ°Ğ´Ğ¾Ğ¼
- Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ ĞºĞ¾Ğ³Ğ´Ğ° ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ñ‡ĞµĞ¼ ĞµÑÑ‚ÑŒ

**ĞšĞ¾Ğ³Ğ´Ğ° ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ:**

- ĞŸÑ€Ğ¸ write-off Ñ shortage
- ĞŸÑ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğµ Ğ±ĞµĞ· stock

**Reconciliation:**

- ĞšĞ¾Ğ³Ğ´Ğ° ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ receipt â†’ negative batch reconciled
- Status: `active` â†’ `depleted`
- `reconciled_at` Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:**

```typescript
// Ğ”Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸:
batches = [] // ĞĞµÑ‚ batches Ğ´Ğ»Ñ Dragon test

// ĞŸĞ¾ÑĞ»Ğµ 1-Ğ¹ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ (20 gram):
batches = [
  {
    batchNumber: 'NEG-PREP-1764858333956',
    currentQuantity: -20,
    costPerUnit: 100000,
    totalValue: -2000000,
    isNegative: true
  }
]

// ĞŸĞ¾ÑĞ»Ğµ 2-Ğ¹ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ (20 gram):
batches = [
  {
    batchNumber: 'NEG-PREP-1764858333956',
    currentQuantity: -40, // â† ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ğ»ÑÑ!
    costPerUnit: 100000,
    totalValue: -4000000,
    isNegative: true
  }
]

// ĞŸĞ¾ÑĞ»Ğµ receipt (Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ 100 gram):
batches = [
  {
    batchNumber: 'NEG-PREP-1764858333956',
    currentQuantity: -40,
    status: 'depleted',
    reconciledAt: '2024-12-04T15:30:00Z' // â† Reconciled!
  },
  {
    batchNumber: 'PREP-1764858500000',
    currentQuantity: 60, // â† ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ¿Ğ¾ÑĞ»Ğµ reconciliation (100 - 40)
    costPerUnit: 95000, // â† ĞĞ¾Ğ²Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¸Ğ· receipt
    isNegative: false
  }
]
```

---

## ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

### ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Payment (Step 2)

```typescript
try {
  await paymentsStore.processSimplePayment(...)
} catch (error) {
  // Rollback: order status â†’ 'pending'
  // Show error to user
  // Payment ĞĞ• ÑĞ¾Ğ·Ğ´Ğ°Ğ½
  // Sales transaction ĞĞ• ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°
  // Write-off ĞĞ• Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½
}
```

### ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Sales Recording (Step 3)

```typescript
try {
  await salesStore.recordSalesTransaction(...)
} catch (error) {
  // Payment Ğ£Ğ–Ğ• ÑĞ¾Ğ·Ğ´Ğ°Ğ½!
  // Order status = 'paid'
  // ĞĞ¾ sales transaction ĞĞ• ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°

  // âš ï¸ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ: Manual reconciliation required!
  // Ğ›Ğ¾Ğ³ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ â†’ errors.md
  // Admin Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ sales transaction
}
```

### ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Write-Off (Step 4)

```typescript
try {
  await recipeWriteOffStore.processItemWriteOff(...)
} catch (error) {
  // Payment ÑĞ¾Ğ·Ğ´Ğ°Ğ½ âœ…
  // Sales transaction ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° âœ…
  // ĞĞ¾ write-off ĞĞ• Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ âŒ

  // ĞŸĞ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ:
  // - Inventory ĞĞ• Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½
  // - Batches ĞĞ• ÑĞ¿Ğ¸ÑĞ°Ğ½Ñ‹
  // - Account expense ĞĞ• Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½

  // Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:
  // 1. Retry Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ (3 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸)
  // 2. Ğ•ÑĞ»Ğ¸ fail â†’ queue for manual write-off
  // 3. Admin Ğ²Ğ¸Ğ´Ğ¸Ñ‚ pending write-offs Ğ² UI
}
```

### ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Negative Batch Cost Calculation (Step 4.4)

```typescript
try {
  const cost = await calculateNegativeBatchCost(preparationId, quantity)
} catch (error) {
  // Ğ’ÑĞµ fallback ÑˆĞ°Ğ³Ğ¸ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸Ğ»Ğ¸ÑÑŒ
  // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ estimated cost: 100 IDR

  console.error(`âŒ CRITICAL: NO COST DATA FOUND`)

  // âš ï¸ WARNING: Inaccurate COGS!
  // Admin Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½:
  // 1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ receipt operation Ğ´Ğ»Ñ preparation
  // 2. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ negative batch cost Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
}
```

---

## Ğ›Ğ¾Ğ³Ğ¸ Ğ¸ Debugging

### ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸:

```typescript
// Step 1: Order creation
console.log('[OrdersStore] Order created:', orderId)

// Step 2: Payment
console.log('[PaymentsStore] Payment processed:', paymentId)

// Step 3: Sales Recording
console.log('[SalesStore] Transaction saved:', transactionId)
console.log('[ActualCostCalculation] Actual cost calculated:', { totalCost })

// Step 4: Write-Off
console.log('[RecipeWriteOffStore] Processing write-off for item:', item)
console.log('[DecompositionEngine] Decomposition complete:', { totalProducts })
console.log('[StorageService] Creating write-off operation:', { documentNumber })
console.log('[StorageService] âš ï¸ Shortage detected - checking for negative batch')
console.log('[NegativeBatchService] ğŸ”„ Attempting dynamic cost calculation')
console.log('[NegativeBatchService] âœ… Calculated theoretical cost:', cost)
console.log('[NegativeBatchService] âœ… Created negative batch:', batchNumber)
```

### Debugging checklist:

1. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ decomposition:**

   ```typescript
   const result = await decomposeMenuItem(menuItemId, variantId, 1)
   console.log('Decomposed items:', result.items)
   ```

2. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ batches:**

   ```typescript
   const batches = preparationStore.batches.filter(
     b => b.preparationId === preparationId && b.department === 'kitchen'
   )
   console.log('Available batches:', batches)
   ```

3. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ingredients:**

   ```typescript
   const ingredients = await supabase
     .from('preparation_ingredients')
     .select('*')
     .eq('preparation_id', preparationId)
   console.log('Ingredients:', ingredients)
   ```

4. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ negative batches:**
   ```typescript
   const negativeBatches = await negativeBatchService.getNegativeBatches(preparationId)
   console.log('Negative batches:', negativeBatches)
   ```

---

## ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Decomposition Services

### Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ (Technical Debt)

Ğ’ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ **3 Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… ÑĞµÑ€Ğ²Ğ¸ÑĞ°** Ğ´Ğ»Ñ Ğ´ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸:

| Ğ¡ĞµÑ€Ğ²Ğ¸Ñ                     | Ğ¤Ğ°Ğ¹Ğ»                                           | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ            |
| -------------------------- | ---------------------------------------------- | --------------------- |
| `useKitchenDecomposition`  | `src/stores/pos/orders/composables/`           | Kitchen Display       |
| `useDecomposition`         | `src/stores/sales/recipeWriteOff/composables/` | Write-off inventory   |
| `useActualCostCalculation` | `src/stores/sales/composables/`                | FIFO cost calculation |

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸. ĞŸÑ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Replacement Modifiers) Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ¼ĞµĞ½ÑÑ‚ÑŒ 3 Ğ¼ĞµÑÑ‚Ğ°.

### Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   useBaseDecomposition      â”‚
                    â”‚   (ĞµĞ´Ğ¸Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€Ğ°)   â”‚
                    â”‚   - recipes traversal       â”‚
                    â”‚   - replacements            â”‚
                    â”‚   - preparations            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚                        â”‚
         â–¼                        â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KitchenAdapter  â”‚    â”‚ WriteOffAdapter â”‚    â”‚  CostAdapter    â”‚
â”‚ (source, role)  â”‚    â”‚ (stops at prep) â”‚    â”‚ (FIFO batches)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ:** [DECOMPOSITION_ARCHITECTURE.md](./DECOMPOSITION_ARCHITECTURE.md)

### Replacement Modifiers

Ğ¡ Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ 2025 Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ **Replacement Modifiers** - Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ° Ğ½Ğ° Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ñƒ:

```
Recipe: Cappuccino
â”œâ”€â”€ Espresso: 30ml
â””â”€â”€ Regular Milk: 150ml  â† Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚

ĞŸÑ€Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğµ Ñ Oat Milk:
â”œâ”€â”€ Espresso: 30ml
â””â”€â”€ Oat Milk: 150ml  â† Ğ·Ğ°Ğ¼ĞµĞ½Ğ° Ğ¸Ğ· modifier composition
```

**ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ‚Ğ¸Ğ¿Ñ‹:**

- `TargetComponent` - ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ°ĞºĞ¾Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ° Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ
- `ModifierGroup.targetComponent` - Ğ´Ğ»Ñ type='replacement'
- `SelectedModifier.groupType`, `targetComponent`, `isDefault`

---

## Ğ—Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ

**ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ - ÑÑ‚Ğ¾ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ¸Ğ· 4 ÑÑ‚Ğ°Ğ¿Ğ¾Ğ²:**

1. âœ… **POS Order** - ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
2. âœ… **Payment** - Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°
3. âœ… **Sales Recording** - ÑƒÑ‡ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶ + COGS calculation
4. âœ… **Write-Off** - ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¸Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² ÑĞ¾ ÑĞºĞ»Ğ°Ğ´Ğ°

**ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸:**

- **Ğ”ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ** Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² Step 4 (Ğ½Ğµ Ğ² Step 3)
- **COGS** ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· FIFO batches (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ negative)
- **Negative batches** ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸ shortage
- **Fallback chain** Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (5 ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹ Ğ´Ğ»Ñ products, 4 Ğ´Ğ»Ñ preparations)
- **Reconciliation** negative batches Ğ¿Ñ€Ğ¸ receipt

**ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:**

- ĞĞ±Ñ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ: ~6-11 ÑĞµĞºÑƒĞ½Ğ´
- ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾: Payment Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¼ (<2 ÑĞµĞº)
- Write-Off Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾ (Ğ² Ñ„Ğ¾Ğ½Ğµ)

**ĞĞ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚ÑŒ:**

- Rollback Ğ´Ğ»Ñ Payment errors
- Retry mechanism Ğ´Ğ»Ñ Write-Off errors
- Manual reconciliation Ğ´Ğ»Ñ critical failures
- ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑÑ‚Ğ°Ğ¿Ğµ
