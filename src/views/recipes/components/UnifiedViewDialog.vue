<!-- src/views/recipes/components/UnifiedViewDialog.vue - –ò–°–ü–†–ê–í–õ–ï–ù–û -->
<template>
  <v-dialog v-model="dialogModel" max-width="900px" scrollable>
    <v-card v-if="item">
      <v-card-title class="text-h5 pa-4 d-flex justify-space-between align-center">
        <div>
          <div class="text-h5">{{ item.name }}</div>
          <div v-if="item.code" class="text-caption text-medium-emphasis">{{ item.code }}</div>
        </div>
        <div class="d-flex gap-2">
          <v-chip
            v-if="type === 'recipe'"
            :color="getDifficultyColor()"
            variant="tonal"
            size="small"
          >
            {{ getDifficultyText() }}
          </v-chip>
          <v-chip color="primary" variant="outlined" size="small">
            {{ getCategoryText() }}
          </v-chip>
          <v-chip v-if="!item.isActive" color="warning" variant="tonal" size="small">
            Archived
          </v-chip>
        </div>
      </v-card-title>

      <v-divider />

      <v-card-text class="pa-0">
        <div class="item-content">
          <!-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Item Info Header —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ props -->
          <item-info-widget
            :item="item"
            :type="itemType"
            :cost-calculation="costCalculation"
            :calculating="calculating"
            @recalculate-cost="recalculateCost"
            @calculate-cost="calculateCost"
          />

          <v-divider />

          <!-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Components Section —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ props -->
          <components-list-widget :item="item" :type="itemType" />

          <v-divider />

          <!-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Instructions Section —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ props -->
          <instructions-widget :item="item" :type="itemType" />

          <!-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Cost Breakdown Section - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ -->
          <cost-breakdown-widget
            v-if="
              costCalculation &&
              costCalculation.componentCosts &&
              costCalculation.componentCosts.length > 0
            "
            :cost-calculation="costCalculation"
            :type="itemType"
          />

          <!-- ‚úÖ –ù–û–í–û–ï: Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ dev —Ä–µ–∂–∏–º–µ -->
          <div v-if="showDebugInfo" class="debug-info pa-4">
            <v-divider class="mb-4" />
            <h4 class="text-subtitle-1 mb-2">üîß Debug Info</h4>
            <v-card variant="outlined" class="pa-3">
              <pre class="text-caption">{{ debugInfo }}</pre>
            </v-card>
          </div>
        </div>
      </v-card-text>

      <v-divider />

      <v-card-actions class="pa-4">
        <v-btn
          v-if="!costCalculation"
          color="info"
          variant="outlined"
          prepend-icon="mdi-calculator"
          :loading="calculating"
          @click="calculateCost"
        >
          Calculate Cost
        </v-btn>
        <v-btn
          v-else
          color="primary"
          variant="outlined"
          prepend-icon="mdi-refresh"
          :loading="calculating"
          @click="recalculateCost"
        >
          Recalculate Cost
        </v-btn>

        <!-- ‚úÖ –ù–û–í–û–ï: Debug toggle –≤ dev —Ä–µ–∂–∏–º–µ -->
        <v-btn v-if="isDev" variant="text" size="small" @click="showDebugInfo = !showDebugInfo">
          {{ showDebugInfo ? 'Hide' : 'Show' }} Debug
        </v-btn>

        <v-spacer />
        <v-btn variant="text" @click="dialogModel = false">Close</v-btn>
        <v-btn color="primary" variant="outlined" prepend-icon="mdi-pencil" @click="editItem">
          Edit {{ type === 'preparation' ? 'Preparation' : 'Recipe' }}
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { useRecipesStore } from '@/stores/recipes'
import { RECIPE_CATEGORIES, PREPARATION_TYPES, DIFFICULTY_LEVELS } from '@/stores/recipes/types'
import type {
  Recipe,
  Preparation,
  PreparationPlanCost,
  RecipePlanCost
} from '@/stores/recipes/types'
import { DebugUtils } from '@/utils'

// Import widgets
import ItemInfoWidget from './widgets/ItemInfoWidget.vue'
import ComponentsListWidget from './widgets/ComponentsListWidget.vue'
import InstructionsWidget from './widgets/InstructionsWidget.vue'
import CostBreakdownWidget from './widgets/CostBreakdownWidget.vue'

interface Props {
  modelValue: boolean
  type: 'recipe' | 'preparation'
  item?: Recipe | Preparation | null
}

interface Emits {
  (e: 'update:modelValue', value: boolean): void
  (e: 'edit', item: Recipe | Preparation): void
  (e: 'calculate-cost', item: Recipe | Preparation): void
}

const props = defineProps<Props>()
const emit = defineEmits<Emits>()

const store = useRecipesStore()
const costCalculation = ref<PreparationPlanCost | RecipePlanCost | null>(null)
const calculating = ref(false)

// ‚úÖ –ù–û–í–û–ï: Debug —Å–æ—Å—Ç–æ—è–Ω–∏–µ
const showDebugInfo = ref(false)
const isDev = computed(() => import.meta.env.DEV)

// Dialog model
const dialogModel = computed({
  get: () => props.modelValue,
  set: (value: boolean) => emit('update:modelValue', value)
})

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —ç–ª–µ–º–µ–Ω—Ç–∞ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ
const itemType = computed(() => {
  if (!props.item) return props.type

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –ø–æ–ª–µ–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞
  if ('components' in props.item && Array.isArray(props.item.components)) {
    return 'recipe'
  }

  if ('recipe' in props.item && Array.isArray(props.item.recipe)) {
    return 'preparation'
  }

  // Fallback –Ω–∞ props.type
  return props.type
})

// ‚úÖ –ù–û–í–û–ï: Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
const debugInfo = computed(() => {
  if (!props.item) return 'No item'

  return {
    type: itemType.value,
    itemKeys: Object.keys(props.item),
    hasComponents: 'components' in props.item,
    hasRecipe: 'recipe' in props.item,
    costCalculation: costCalculation.value
      ? {
          type: costCalculation.value.type,
          totalCost: costCalculation.value.totalCost,
          componentCosts: costCalculation.value.componentCosts?.length || 0
        }
      : null,
    itemStructure: {
      name: props.item.name,
      id: props.item.id,
      // –î–ª—è preparation
      ...(itemType.value === 'preparation' && {
        outputQuantity: (props.item as Preparation).outputQuantity,
        outputUnit: (props.item as Preparation).outputUnit,
        recipeLength: (props.item as Preparation).recipe?.length || 0
      }),
      // –î–ª—è recipe
      ...(itemType.value === 'recipe' && {
        portionSize: (props.item as Recipe).portionSize,
        portionUnit: (props.item as Recipe).portionUnit,
        componentsLength: (props.item as Recipe).components?.length || 0
      })
    }
  }
})

function getCategoryText(): string {
  if (!props.item) return ''

  if (itemType.value === 'preparation') {
    const prep = props.item as Preparation
    const category = PREPARATION_TYPES.find(c => c.value === prep.type)
    return category?.text || prep.type
  } else {
    const recipe = props.item as Recipe
    const category = RECIPE_CATEGORIES.find(c => c.value === recipe.category)
    return category?.text || recipe.category
  }
}

function getDifficultyColor(): string {
  if (itemType.value !== 'recipe' || !props.item) return 'grey'

  const recipe = props.item as Recipe
  const level = DIFFICULTY_LEVELS.find(l => l.value === recipe.difficulty)
  return level?.color || 'grey'
}

function getDifficultyText(): string {
  if (itemType.value !== 'recipe' || !props.item) return ''

  const recipe = props.item as Recipe
  const level = DIFFICULTY_LEVELS.find(l => l.value === recipe.difficulty)
  return level?.text || recipe.difficulty
}

async function calculateCost() {
  if (!props.item) return

  calculating.value = true
  try {
    DebugUtils.info('UnifiedViewDialog', `üßÆ Calculating cost for ${itemType.value}`, {
      id: props.item.id,
      name: props.item.name
    })

    if (itemType.value === 'preparation') {
      const result = await store.calculatePreparationCost(props.item.id)
      costCalculation.value = result
      DebugUtils.info('UnifiedViewDialog', '‚úÖ Preparation cost calculated', {
        totalCost: result.totalCost,
        costPerUnit: result.costPerOutputUnit
      })
    } else {
      const result = await store.calculateRecipeCost(props.item.id)
      costCalculation.value = result
      DebugUtils.info('UnifiedViewDialog', '‚úÖ Recipe cost calculated', {
        totalCost: result.totalCost,
        costPerPortion: result.costPerPortion
      })
    }

    emit('calculate-cost', props.item)
  } catch (error) {
    DebugUtils.error('UnifiedViewDialog', '‚ùå Failed to calculate cost', { error })
    costCalculation.value = null
  } finally {
    calculating.value = false
  }
}

async function recalculateCost() {
  await calculateCost()
}

function editItem() {
  if (props.item) {
    emit('edit', props.item)
    dialogModel.value = false
  }
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Watch –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ cost calculation
watch(
  () => props.item,
  newItem => {
    if (newItem) {
      DebugUtils.info('UnifiedViewDialog', `üìã Item changed: ${newItem.name}`, {
        type: itemType.value,
        id: newItem.id
      })

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π cost calculation
      if (itemType.value === 'preparation') {
        costCalculation.value = store.getPreparationCostCalculation(newItem.id)
      } else {
        costCalculation.value = store.getRecipeCostCalculation(newItem.id)
      }

      DebugUtils.debug('UnifiedViewDialog', 'üí∞ Cost calculation loaded', {
        hasCostCalculation: !!costCalculation.value,
        totalCost: costCalculation.value?.totalCost || 0
      })
    } else {
      costCalculation.value = null
    }
  },
  { immediate: true }
)

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Watch –¥–ª—è —Ç–∏–ø–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
watch(
  () => itemType.value,
  newType => {
    DebugUtils.debug('UnifiedViewDialog', `üîÑ Item type determined: ${newType}`)
  },
  { immediate: true }
)
</script>

<style lang="scss" scoped>
.item-content {
  // Clean styles without conflicts
}

.debug-info {
  background: #f5f5f5;
  border-top: 2px dashed #ddd;

  pre {
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 11px;
    line-height: 1.4;
  }
}

:deep(.dark) {
  .debug-info {
    background: #2a2a2a;
    border-top-color: #555;
  }
}
</style>
