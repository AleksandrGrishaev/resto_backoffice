// src/stores/pos/index.ts - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô —Å —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
import { defineStore } from 'pinia'
import { ref, computed, watch } from 'vue'
import type { ServiceResponse } from '@/repositories/base'
import { usePlatform } from '@/composables/usePlatform'

// –ò–º–ø–æ—Ä—Ç –≤—Å–µ—Ö POS stores
import { usePosTablesStore } from './tables/tablesStore'
import { usePosOrdersStore } from './orders/ordersStore'
import { usePosPaymentsStore } from './payments/paymentsStore'

// Types (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ)
interface DailySalesStats {
  totalAmount: number
  totalOrders: number
  averageOrderValue: number
  paymentMethods: {
    cash: { count: number; amount: number }
    card: { count: number; amount: number }
    qr: { count: number; amount: number }
  }
  orderTypes: {
    dineIn: number
    takeaway: number
    delivery: number
  }
}

interface ShiftReport {
  shiftId: string
  startTime: string
  endTime?: string
  cashierId: string
  cashierName: string
  totalOrders: number
  totalAmount: number
  totalTax: number
  totalDiscounts: number
  paymentBreakdown: {
    cash: { count: number; amount: number }
    card: { count: number; amount: number }
    qr: { count: number; amount: number }
  }
  voidedOrders: number
  voidedAmount: number
}

/**
 * –ì–ª–∞–≤–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä POS —Å–∏—Å—Ç–µ–º—ã - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
 */
export const usePosStore = defineStore('pos', () => {
  const platform = usePlatform()

  // ===== STATE =====
  const isInitialized = ref(false)
  const isOnline = ref(navigator.onLine)
  const lastSync = ref<string | null>(null)
  const error = ref<string | null>(null)

  // Current shift state
  const currentShift = ref<{
    id: string
    startTime: string
    cashierId: string
    cashierName: string
    startingCash: number
  } | null>(null)

  // ===== STORES =====
  const tablesStore = usePosTablesStore()
  const ordersStore = usePosOrdersStore()
  const paymentsStore = usePosPaymentsStore()

  // ===== COMPUTED =====

  const isReady = computed(() => {
    return isInitialized.value && !error.value
  })

  const dailyStats = computed((): DailySalesStats | null => {
    if (!isInitialized.value) return null

    // TODO: Implement when orders/payments are working
    return {
      totalAmount: 0,
      totalOrders: 0,
      averageOrderValue: 0,
      paymentMethods: {
        cash: { count: 0, amount: 0 },
        card: { count: 0, amount: 0 },
        qr: { count: 0, amount: 0 }
      },
      orderTypes: {
        dineIn: 0,
        takeaway: 0,
        delivery: 0
      }
    }
  })

  const currentShiftReport = computed((): ShiftReport | null => {
    if (!currentShift.value || !isInitialized.value) return null

    const shift = currentShift.value

    // TODO: Calculate real data when stores are working
    return {
      shiftId: shift.id,
      startTime: shift.startTime,
      endTime: undefined,
      cashierId: shift.cashierId,
      cashierName: shift.cashierName,
      totalOrders: 0,
      totalAmount: 0,
      totalTax: 0,
      totalDiscounts: 0,
      paymentBreakdown: {
        cash: { count: 0, amount: 0 },
        card: { count: 0, amount: 0 },
        qr: { count: 0, amount: 0 }
      },
      voidedOrders: 0,
      voidedAmount: 0
    }
  })

  // ===== ACTIONS =====

  /**
   * ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è POS —Å–∏—Å—Ç–µ–º—ã
   */
  async function initializePOS(): Promise<ServiceResponse<void>> {
    if (isInitialized.value) {
      platform.debugLog('POS', 'Already initialized, skipping')
      return { success: true }
    }

    try {
      platform.debugLog('POS', 'üîç Starting POS initialization...')
      error.value = null

      // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ stores –¥–æ—Å—Ç—É–ø–Ω—ã
      const storesAvailable = !!(tablesStore && ordersStore && paymentsStore)

      if (!storesAvailable) {
        throw new Error('POS stores not available')
      }

      // TODO: –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      // - –ó–∞–≥—Ä—É–∑–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–µ–Ω—é
      // - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
      // - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ —Å –∫—É—Ö–Ω–µ–π

      // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é
      isInitialized.value = true
      lastSync.value = new Date().toISOString()

      platform.debugLog('POS', '‚úÖ POS system initialized', {
        platform: platform.platform.value,
        offline: platform.offlineEnabled.value
      })

      return { success: true }
    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : 'Failed to initialize POS'
      error.value = errorMsg

      platform.debugLog('POS', '‚ùå POS initialization failed', { error: errorMsg })

      return {
        success: false,
        error: errorMsg,
        metadata: {
          timestamp: new Date().toISOString(),
          source: 'local'
        }
      }
    }
  }

  /**
   * –ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É
   */
  async function startShift(
    cashierId: string,
    cashierName: string,
    startingCash: number = 0
  ): Promise<ServiceResponse<void>> {
    try {
      if (currentShift.value) {
        throw new Error('Shift already started')
      }

      const shiftId = `shift_${Date.now()}`
      const startTime = new Date().toISOString()

      currentShift.value = {
        id: shiftId,
        startTime,
        cashierId,
        cashierName,
        startingCash
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–º–µ–Ω–µ
      const storage = platform.getStorageInterface()
      storage.setItem('pos_current_shift', JSON.stringify(currentShift.value))

      platform.debugLog('POS', `‚úÖ Shift started: ${shiftId}`, {
        cashier: cashierName,
        startingCash
      })

      return { success: true }
    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : 'Failed to start shift'
      error.value = errorMsg
      return { success: false, error: errorMsg }
    }
  }

  /**
   * –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É
   */
  async function endShift(): Promise<ServiceResponse<ShiftReport>> {
    try {
      if (!currentShift.value) {
        throw new Error('No active shift')
      }

      const report = currentShiftReport.value
      if (!report) {
        throw new Error('Cannot generate shift report')
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
      const finalReport: ShiftReport = {
        ...report,
        endTime: new Date().toISOString()
      }

      // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É
      currentShift.value = null
      const storage = platform.getStorageInterface()
      storage.removeItem('pos_current_shift')

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç
      // TODO: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é —Å–º–µ–Ω

      platform.debugLog('POS', '‚úÖ Shift ended', {
        shiftId: finalReport.shiftId,
        duration: finalReport.endTime
      })

      return { success: true, data: finalReport }
    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : 'Failed to end shift'
      error.value = errorMsg
      return { success: false, error: errorMsg }
    }
  }

  /**
   * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º (–∑–∞–≥–ª—É—à–∫–∞)
   */
  async function syncWithServer(): Promise<ServiceResponse<void>> {
    try {
      if (!platform.isOnline.value) {
        throw new Error('Cannot sync while offline')
      }

      // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
      lastSync.value = new Date().toISOString()

      platform.debugLog('POS', '‚úÖ Sync completed (mock)')
      return { success: true }
    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : 'Sync failed'
      return { success: false, error: errorMsg }
    }
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å –æ—à–∏–±–∫—É
   */
  function clearError(): void {
    error.value = null
  }

  /**
   * –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
   */
  function reset(): void {
    isInitialized.value = false
    error.value = null
    currentShift.value = null
    lastSync.value = null
  }

  // ===== WATCHERS =====

  // –°–ª–µ–¥–∏–º –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º —Å–µ—Ç–∏
  watch(isOnline, online => {
    platform.debugLog('POS', `Network status changed: ${online ? 'ONLINE' : 'OFFLINE'}`)

    if (online && isInitialized.value) {
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏
      syncWithServer().catch(err => {
        platform.debugLog('POS', 'Auto-sync failed', { error: err.message })
      })
    }
  })

  // ===== LIFECYCLE =====

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–º–µ–Ω—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ store
  function restoreShift(): void {
    try {
      const storage = platform.getStorageInterface()
      const savedShift = storage.getItem('pos_current_shift')

      if (savedShift) {
        currentShift.value = JSON.parse(savedShift)
        platform.debugLog('POS', 'Shift restored from storage', {
          shiftId: currentShift.value?.id
        })
      }
    } catch (error) {
      platform.debugLog('POS', 'Failed to restore shift', { error })
    }
  }

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–º–µ–Ω—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ store
  restoreShift()

  // ===== RETURN =====

  return {
    // State
    isInitialized,
    isOnline,
    lastSync,
    error,
    currentShift,

    // Getters
    isReady,
    dailyStats,
    currentShiftReport,

    // Store references
    tablesStore,
    ordersStore,
    paymentsStore,

    // Actions
    initializePOS,
    startShift,
    endShift,
    syncWithServer,
    clearError,
    reset
  }
})
